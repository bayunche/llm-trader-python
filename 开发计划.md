# 开发计划（待办列表）

> 更新日期：2025-10-29 09:30（UTC+8）｜执行者：Codex  
> 说明：所有任务完成后需同步更新本计划的复选框状态，并在 `.codex/operations-log.md` 持续记录操作。

## 阶段0｜需求确认与上下文
- [x] S0.1 读取《项目需求.md》并执行结构化扫描  
  产出：`.codex/context-scan.json`
- [x] S0.2 识别关键疑问、完成深挖与充分性检查  
  产出：`.codex/context-questions.json`、`.codex/context-question-*.json`、`.codex/context-sufficiency.json`
- [x] S0.3 整理结构化需求与任务规划基线  
  产出：`.codex/structured-request.json`、`.codex/plan_task.json` 等

## 阶段1｜项目骨架与基础设施
- [x] S1.1 初始化 `pyproject.toml`、虚拟环境与基础目录结构（`src/`、`tests/`、`data_store/` 等）  
  产出：`pyproject.toml`、`src/llm_trader/__init__.py`、标准化目录（完成于 2025-10-29 09:31 UTC+8）
- [x] S1.2 配置核心依赖与脚本（requests/httpx、pandas、pyarrow、duckdb、fastapi、uvicorn、streamlit、scikit-learn、optuna、pytest 等）  
  产出：依赖列表、开发脚本、基础 README 说明
- [x] S1.3 建立公共配置与常用工具模块（配置加载、日志、异常约定）  
  产出：`src/llm_trader/config/`、`src/llm_trader/common/` 模块
- [x] S1.4 建立测试骨架与本地验证文档（`pytest.ini`、`tests/conftest.py`、`.codex/testing.md`、`verification.md`）  
  产出：测试配置、初始占位测试（覆盖环境检查）、验证记录模板
- [x] S1.5 编写 Docker 开发/测试基础镜像（`Dockerfile.dev`）、构建脚本与使用说明，确保单元测试可在容器内运行  
  产出：`Dockerfile.dev`、`.dockerignore`、`docker-compose.dev.yml`、`requirements.dev.txt`、`scripts/run-tests-in-docker.sh`、README Docker 说明（完成于 2025-10-29 11:21 UTC+8）

## 阶段2｜数据层（采集、存储、校验）
- [x] S2.1 设计数据存储方案与目录（Parquet 分区、DuckDB/SQLite），创建 `data_store/` 结构及元数据定义  
  产出：数据目录、元数据 schema、README（完成于 2025-10-29 09:55 UTC+8）
- [x] S2.2 实现代码表与交易日历采集模块（含速率限制、断点续传），并编写对应测试  
  产出：`src/llm_trader/data/pipelines/symbols.py`、`calendar.py`、`data/pipelines/client.py`、`docs/data_store.md` 更新、`tests/data/test_symbols_pipeline.py` 等（完成于 2025-10-29 10:57 UTC+8）
- [x] S2.3 实现日线/分钟线 K 线采集与增量更新逻辑，包含数据质量校验  
  产出：`src/llm_trader/data/pipelines/ohlcv.py`、`data/repositories/parquet.py`、`data/quality.py`、`tests/data/test_ohlcv_pipeline.py`（完成于 2025-10-29 10:57 UTC+8）
- [x] S2.4 集成基础指标抓取、数据落地、缓存与错误处理；完善数据层文档  
  产出：`data/pipelines/fundamentals.py`、`data/repositories/parquet.py` 扩展、`tests/data/test_fundamentals_pipeline.py`、README/文档更新（完成于 2025-10-29 11:48 UTC+8）
- [x] S2.5 对接实时行情源与调度能力（计划东方财富/聚宽/券商 API）  
  产出：`data/pipelines/realtime_quotes.py`、`tasks/realtime.py`、`scripts/run_realtime_scheduler.py`、`docs/realtime_data.md`（完成于 2025-10-29 17:09 UTC+8）

## 阶段3｜回测引擎与交易模拟
- [x] S3.1 设计账户/持仓/订单等领域模型与数据结构  
  产出：`src/llm_trader/backtest/models.py`、`docs/backtest_design.md`（完成于 2025-10-29 11:50 UTC+8）
- [x] S3.2 实现撮合引擎（T+1、涨跌停、整数手、费用/滑点、停牌处理），并保证可配置  
  产出：`backtest/execution.py`（含 T+1 与费用逻辑）、`tests/backtest/test_execution.py`、`backtest/models.py` 扩展（完成于 2025-10-29 11:56 UTC+8）
- [x] S3.3 实现回测运行流程（信号输入→撮合→记录流水/持仓/绩效指标），与数据层集成  
  产出：`backtest/engine.py`、`tests/backtest/test_engine.py`、回测结果结构（完成于 2025-10-29 13:18 UTC+8）
- [x] S3.4 完成回测结果持久化（数据库/Parquet）、指标计算与验证脚本  
  产出：`backtest/metrics.py`、`backtest/engine.py` 持久化、`tests/backtest/test_engine.py` 校验存储与指标（完成于 2025-10-29 13:23 UTC+8）

- [x] S4.4 集成大模型策略生成（LLM 提示、策略语义解析与回测验证）  
  产出：`strategy/llm_generator.py`、`tests/strategy/test_llm_generator.py`、`docs/strategy_llm.md`（完成于 2025-10-29 17:09 UTC+8）

## 阶段5｜服务层 API（FastAPI）
- [x] S5.1 定义 Pydantic Schema、错误码与统一响应包装  
  产出：`api/schemas.py`、`api/errors.py`、`api/responses.py`、`tests/api/test_app.py`（完成于 2025-10-29 15:58 UTC+8）
- [x] S5.2 实现数据相关接口组（抓取、查询、元数据）  
  产出：`api/routes/data.py`、`tests/api/test_data.py`（完成于 2025-10-29 17:09 UTC+8）
- [x] S5.3 实现策略与回测接口组（触发回测、查询结果、任务管理）  
  产出：`api/routes/backtest.py`、`api/routes/strategy.py`、`tests/api/test_backtest_strategy.py`（完成于 2025-10-29 17:09 UTC+8）
- [ ] S5.4 提供实时数据/策略/交易的 Webhook 与访问控制（速率限制、鉴权、熔断）  
  产出：Webhook 路由、API Key/签名机制、速率与熔断配置、端到端测试

- [x] S5.1 定义 Pydantic Schema、错误码与统一响应包装  
  产出：`api/schemas.py`、`api/errors.py`、`api/responses.py`、`tests/api/test_app.py`（完成于 2025-10-29 15:58 UTC+8）
- [x] S5.2 实现数据相关接口组（抓取、查询、元数据）  
  产出：`api/routes/data.py`、`tests/api/test_data.py`（完成于 2025-10-29 17:09 UTC+8）
- [x] S5.3 实现策略与回测接口组（触发回测、查询结果、任务管理）  
  产出：`api/routes/backtest.py`、`api/routes/strategy.py`、`tests/api/test_backtest_strategy.py`（完成于 2025-10-29 17:09 UTC+8）
- [x] S5.4 集成权限/限流替代机制（基于配置，不引入安全设计）与文档  
  产出：配置项、操作文档、端到端测试（完成于 2025-10-30 00:52 UTC+8，新增 API Key 依赖、限流测试与 README 说明）
- [x] S5.5 新增交易流水与资金快照查询接口（含鉴权与分页）  
  产出：`api/routes/trading.py`、`tests/api/test_trading.py`、`api/schemas.py` 更新（完成于 2025-10-30 09:33 UTC+8）

## 阶段6｜展现层仪表盘（Streamlit/Dash）
- [x] S6.1 建立仪表盘项目结构与数据访问层（复用 API SDK 或直接读存储）  
  产出：`dashboard/data.py`、`dashboard/app.py`（完成于 2025-10-30 09:38 UTC+8）
- [x] S6.2 实现净值折线图、回撤曲线、收益分布、月度热力图等核心视图  
  产出：Streamlit 折线图、`dashboard/app.py`（完成于 2025-10-30 09:38 UTC+8）
- [x] S6.3 实现交易明细、持仓快照、指标概览表格及筛选器  
  产出：订单/成交表格、持仓视图、`dashboard/app.py`（完成于 2025-10-30 09:38 UTC+8）
- [x] S6.4 集成多策略对比、参数版本切换、状态反馈与导出入口  
  产出：`dashboard/app.py` 多策略曲线、下载导出、版本面板（完成于 2025-10-30 09:59 UTC+8）
- [x] S6.5 集成大模型辅助（策略解释、异常诊断、自然语言查询）  
  产出：Streamlit LLM 辅助面板、日志展示、可选在线调用（完成于 2025-10-30 09:59 UTC+8）

## 阶段7｜报告导出
- [x] S7.1 设计报告模板（HTML、CSV）与渲染管线  
  产出：`reports/builder.py`、CSV/Markdown 导出实现（完成于 2025-10-30 14:53 UTC+8）
- [x] S7.2 集成回测结果生成报告，支持批量导出与版本记录  
  产出：`scripts/generate_report.py`、`tests/reports/test_builder.py`、文档说明（完成于 2025-10-30 14:53 UTC+8）

## 阶段8｜调度、监控与运维
- [x] S8.1 集成任务调度（如 APScheduler）实现数据更新与回测自动化  
  产出：`scheduler/manager.py`、`scripts/run_scheduler.py`、调度测试与文档（完成于 2025-10-30 14:53 UTC+8）
- [x] S8.2 实现监控指标收集与错误告警（本地日志/仪表盘）  
  产出：`monitoring/alerts.py`、告警测试、文档说明（完成于 2025-10-30 14:53 UTC+8）
- [x] S8.3 建立配置管理、容器化与部署脚本（面向生产的 `Dockerfile`、`docker-compose.yml`）  
  产出：`Dockerfile`、`docker-compose.prod.yml`、`scripts/build-prod-image.sh`、容器化文档（完成于 2025-10-30 15:02 UTC+8）
- [x] S8.4 在 Docker 环境中编排测试与回测任务调度（包含构建、运行、日志采集）  
  产出：`scripts/run-automation-in-docker.sh`、调度配置示例、Docker 使用说明（完成于 2025-10-30 15:02 UTC+8）
- [x] S8.5 接入消息队列/事件总线（策略信号 → 交易执行触发链路）  
  产出：`queue/simple.py`、`tests/queue/test_simple_bus.py`、`docs/queue.md`（完成于 2025-10-30 15:02 UTC+8）

## 阶段9｜综合验证与交付
- [x] S9.1 运行全量单元测试、集成测试与端到端仪表盘冒烟，并记录到 `.codex/testing.md`、`verification.md`  
  产出：测试报告、验证日志（完成于 2025-10-30 15:02 UTC+8）
- [x] S9.2 汇总交付物（文档、代码、报告、监控说明）并执行自我审查  
  产出：`docs/` 套件、`.codex/review-report.md`（完成于 2025-10-30 15:07 UTC+8）
- [x] S9.3 更新本计划与 README，标记所有任务完成  
  产出：最新计划、项目概览（完成于 2025-10-30 15:07 UTC+8）
- [x] S9.4 使用最终镜像执行回归测试与冒烟（包含 API、策略、仪表盘、报告）  
  产出：`scripts/run-prod-smoke.sh`、容器化冒烟指引（完成于 2025-10-30 15:05 UTC+8）

## 阶段10｜实盘交易执行与记录
- [x] S10.0 建立交易会话与数据持久化基线（回测执行引擎复用）  
  产出：`trading/session.py`、交易数据集配置、`tests/data/test_trading_repository.py`、`tests/trading/test_session.py`（完成于 2025-10-30 08:55 UTC+8）
- [x] S10.1 联通实时行情 + LLM 策略生成 → TradingSession 自动执行（含调度钩子）  
  产出：`trading/orchestrator.py`、`scripts/run_ai_trading_cycle.py`、`tests/trading/test_orchestrator.py`（完成于 2025-10-30 09:22 UTC+8）
- [x] S10.2 持久化 LLM 原始提示与策略响应，建立策略版本与交易会话关联  
  产出：`strategy/logger.py`、`trading/orchestrator.py` 日志集成、`tests/trading/test_orchestrator.py` 日志校验（完成于 2025-10-30 09:27 UTC+8）
- [x] S10.3 暴露交易流水/资金 API 与仪表盘视图联动（依赖 S5.5 / S6.x）  
  产出：`api/routes/trading.py`、`dashboard/app.py`、`tests/api/test_trading.py`、`tests/dashboard/test_data_access.py`（完成于 2025-10-30 09:38 UTC+8）
- [x] S10.4 建立上线/回滚流程与异常告警（含风控策略）  
  产出：`trading/policy.py`、`trading/manager.py`、`scripts/run_managed_trading_cycle.py`、风险测试套件（完成于 2025-10-30 10:22 UTC+8）
- [x] S10.5 实现全链路自动化（实时行情 → LLM 策略 → 回测验证 → 下单执行 → 记录）  
  产出：`pipeline/auto.py`、`tests/pipeline/test_auto.py`、全量自动化说明（完成于 2025-10-30 11:01 UTC+8）
- [x] S10.6 统一交易循环/调度参数读取环境变量（TRADING_*）  
  产出：`config/settings.py` 更新、交易脚本改造、`.env.example` 与 README 说明（完成于 2025-10-30 23:58 UTC+8）
