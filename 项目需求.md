# A股自动交易代理项目需求（2025-11-03）

> **执行者：Codex** ｜ **适用版本：Alpha（模拟闭环）**  
> 本需求文档聚焦当前已实现的模拟交易能力，并明确尚未完成的闭环要素（报表生成、实盘执行）。后续里程碑需在此基础上扩展。

---

## 1. 版本目标与范围

### 1.1 Alpha 范围（已交付）

1. **数据采集与治理**：自动同步东方财富证券主表、交易日历、日/分钟线行情、实时行情及基础指标，落地 Parquet 数据仓储。
2. **策略生成（LLM）**：调用 OpenAI 兼容接口，根据目标/历史摘要生成规则与 `selected_symbols`，输出结构化策略建议。
3. **模拟交易执行**：复用回测撮合引擎完成订单撮合、交易流水、账户权益与持仓记录，支持风控阈值控制。
4. **自动化流水线**：提供“策略生成 → 回测验收 → 风控决策”的一体化执行入口，可配置回测指标阈值。
5. **可视化与运维**：Streamlit 仪表盘展示资金曲线、订单、成交及 LLM 日志；调度脚本管理数据与交易作业。
6. **报表导出**：支持生成包含指标、资金曲线、订单/成交、LLM 日志汇总的 CSV/Markdown/JSON 报告。
7. **提示词模板管理**：内置默认策略提示词模板，支持通过仪表盘查看、编辑、保存及重置，修改内容持久化至可写目录并立即影响后续策略生成。

### 1.2 Roadmap（待交付）

- **交易模式切换**：在 `.env` 中新增 `TRADING_EXECUTION_MODE`，支持 `sandbox`（默认）与 `live`，并根据模式选择撮合器或券商执行器。
- **报表导出**：实现 `llm_trader.reports` 模块，支持 CSV/Markdown/JSON 导出，Docker 自动流程中自动生成。
- **Docker 一键全流程**：启动容器即执行“数据同步 → 策略生成 → 交易执行（按模式切换）→ 报表生成 → Dashboard 启动”，同时整合日志输出。
- **监控与告警**：扩展实时风险告警、作业重试、健康检查等运维能力。
- **体验优化**：增强仪表盘交互、提升大数据量性能、补充多策略对比工具。

---

## 2. 功能需求

### 2.1 Alpha Must Have（已实现）

| 功能域 | 需求 | 约束/实现要点 |
| --- | --- | --- |
| 数据采集 | 证券、日历、行情、实时、基础指标抓取与增量更新 | 接口来源东方财富；需要速率限制、断点续传、数据质量校验。 |
| 数据存储 | Parquet + 目录分区，提供读写接口 | 通过 `ParquetRepository` 封装写入、去重、增量合并。 |
| 策略生成 | 基于 LLM 生成规则及标的选择 | 必须校验 JSON 输出、规则完整性、`selected_symbols` 非空。 |
| 信号执行 | 生成订单、调用撮合、记录流水与权益 | 仅支持模拟撮合；风控阈值包含最大回撤、仓位占比。 |
| 自动化流水线 | 一键执行策略生成→回测→风控 | 若回测不达标需终止流程并返回状态码。 |
| 可视化 | Streamlit 展示策略日志、资金曲线、订单、成交 | 支持多策略/多会话对比、LLM 日志回溯、CSV 导出。 |
| 调度 | APScheduler/脚本触发数据抓取与交易循环 | JSON 配置作业、支持 CLI 快速启动。 |
| 报表导出 | 输出 CSV/Markdown/JSON 报表并返回路径 | 通过 `llm_trader.reports` 生成；自动化/ Docker 流程自动触发。 |

### 2.2 Beta Backlog（未完成）

| 编号 | 需求 | 描述 |
| --- | --- | --- |
| R1 | 实盘执行落地 | 在现有 mock 券商基础上接入真实券商 API、额度校验与失败回滚。 |
| R2 | Docker 周期化流程 | 在容器内支持多轮执行或定时调度，输出阶段化报表并暴露健康检查。 |
| R3 | 报表增强 | 扩展报表模板（含 PDF/图表）、支持历史归档与版本比对。 |
| R4 | 告警与监控 | 增加任务失败告警、风险提醒、健康检查端点。 |
| R5 | 用户体验 | 优化仪表盘性能、新增多策略分析工具、完善日志检索。 |
| R6 | 测试资产 | 增补多标的、多频率、极端行情用例，覆盖沙盒/实盘及报表流程。 |
| R7 | 提示词多模板支持 | 基于现有管理器扩展多策略、多场景模板，同时提供版本比对与审计。 |

---

## 3. 非功能需求

- **性能**：常规自动化流程（单策略、日级数据）应在 5 分钟内完成；仪表盘首屏加载控制在 2 秒以内（数据量≤10 万行）；Docker 一键流程首轮执行在 10 分钟内完成。
- **可靠性**：数据采集需具备重试、熔断与失败记录；自动化流水线在任何环节失败时返回明确状态码与诊断信息；`live` 模式执行必须具备失败回滚。
- **可运维性**：所有关键操作写入日志/Parquet，支持脱机排查；调度作业应支持 JSON 配置与命令行覆盖；Docker 日志需区分数据/策略/交易/报表/仪表盘阶段。
- **可测试性**：核心模块必须有单元测试覆盖；自动化流程需提供注入式依赖以便 Mock 测试；新增沙盒/实盘模式应具备模拟桩与自动化验证。
- **合规性**：严格遵守数据源服务条款，限速、缓存与用途不可违反相关规定。
- **健康检查**：提供 CLI 或 HTTP 健康检查，覆盖状态文件检测、提示词模板校验，可作为容器 Healthcheck 使用。

---

## 4. 业务规则（模拟交易）

- **成交制度**：T+1，买入当日不可卖出；默认次日开盘价撮合，可配置最新价/收盘价撮合。  
- **涨跌停**：普通 ±10%，ST ±5%，支持参数化配置。  
- **最小单位**：100 股整数手。  
- **费用**：佣金按成交额百分比，卖出收取印花税，沪市加过户费，支持最低费用。  
- **停牌/退市**：不可下单，已有持仓冻结。  
- **流动性过滤**：可按成交额/量进行过滤，未实现冲击成本。  
- **风险阈值**：最大回撤、单票仓位占比用于熔断，后续扩展更多指标。  
- **执行模式**：默认使用沙盒撮合；当 `.env` 设置 `TRADING_EXECUTION_MODE=live` 时，需调用券商执行器进行真实下单，并在执行前进行额度与风险校验。  
- **数据维护**：支持前复权数据输入，暂未在模拟中处理分红派息（后续在 Beta 阶段补齐）。

---

## 5. 系统架构概览

```
┌─────────────────────────────┐
│        调度与任务管理        │ scripts/run_scheduler.py │
└──────────────┬──────────────┘
               │
┌──────────────▼──────────────┐
│      自动化流水线（pipeline）│ run_full_automation      │
└──────────────┬──────────────┘
               │
┌───────┬──────▼─────┬────────┐
│ 数据层│ 策略层      │ 交易层   │
│ pipelines │ llm_generator │ trading │
└───────┴──────┬─────┴────────┘
               │
         ┌─────▼─────┐
         │   报表层   │ llm_trader.reports │
         └─────┬─────┘
               │
┌──────────────▼──────────────┐
│       可视化与服务层         │ Streamlit / FastAPI      │
└─────────────────────────────┘
```

> Beta 阶段将在交易层下方扩展“执行适配器”与“报表模块”，流水线与 Docker 容器将形成“一键启动→全流程→Dashboard”的完整闭环。

---

## 6. 验收标准（Alpha）

1. **功能验证**：
   - 能成功运行 `run_ai_trading_cycle.py`，生成订单并落地至 `data_store/`。
   - `run_full_automation` 在回测通过时返回 `executed`，未达标时返回 `backtest_rejected`。
   - 仪表盘可展示资金曲线、订单、成交与 LLM 日志。
2. **数据一致性**：
   - 数据采集任务能够增量更新且无重复记录（通过单测验证）。
3. **日志与监控**：
   - 关键操作写入 Parquet，仪表盘可读取同一数据源。
4. **测试覆盖**：
   - `env PYTHONPATH=src python -m pytest` 通过全部现有测试。
5. **文档同步**：
   - README、开发计划、需求文档保持与实现一致，并注明日期。

---

## 7. 术语与合规说明

- **模拟交易**：指在本地撮合引擎中完成的订单执行，不涉及真实资金或券商账户。  
- **报表模块**：尚未实现的功能，旨在生成 CSV/Markdown/JSON 报告。  
- **实盘执行**：指未来接入券商/交易所 API 的能力，当前版本不提供。  
- **使用限制**：本项目仅用于研究/教学，策略结果与日志不构成投资建议。
