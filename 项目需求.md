# A股自动交易代理（Agent）技术与需求方案（无代码版）

> 目标：在本地沙箱环境中运行的 Python 项目，**基于东方财富公开可访问数据**实现“自动生成交易策略→模拟交易/回测→结果保存→可视化仪表盘（含折线图）”。本方案仅为**功能点与接口契约**，**不含代码**。
> 合规提示：严格遵守目标网站服务条款与频控要求；仅用于研究/教学，**不构成投资建议**。

---

## 1. 范围与目标

* **必须实现**

  * A股数据的自动抓取/更新（代码表、交易日历、日线与分钟线、基础指标）
  * 策略的自动生成（规则组合/搜索/优化）与选择
  * 本地模拟交易/回测（含 T+1、涨跌停、手数、费用/滑点）
  * 交易流水、持仓快照、绩效指标、日志的持久化
  * 可交互仪表盘：净值**折线图**、回撤、收益分布、交易明细、对比分析
  * 报告导出（HTML/PDF/CSV）

* **不在本期**

  * 实盘接口对接与下单
  * Tick/超高频级别交易

---

## 2. 关键业务规则（A股仿真约束）

* **成交制度**：T+1，买入当日不可卖出
* **涨跌停**：普通 ±10%，ST ±5%（可配置）；创业板/科创/北交所有差异（参数化管理）
* **最小交易单位**：1手=100股
* **费用**：佣金（双边）、印花税（卖出）、过户费（沪市），设定最低费用门槛
* **撮合时点**：默认次日开盘价撮合；可切换“收盘信号→下根K开盘成交/收盘成交”
* **停牌/退市**：不可交易；停牌持仓冻结
* **流动性约束**：按成交额/量过滤；可选冲击成本模型
* **复权/分红送转**：支持前复权数据或在回测层做现金红利与股本调整

---

## 3. 体系结构（逻辑视图）

* **数据层（ETL & 缓存）**：东方财富公开数据→解析→校验→落地（SQLite/DuckDB + Parquet 分区）
* **策略层（生成与选择）**：规则库、参数搜索、进化/贝叶斯优化、防过拟合
* **回测层（撮合与组合）**：撮合引擎、账户与仓位管理、风险控制、绩效评估
* **服务层（API）**：FastAPI 风格 REST 接口，统一返回JSON，字段标准化
* **展现层（仪表盘）**：Streamlit/Dash 实现交互视图（净值折线图、明细表、筛选器）
* **运维层**：任务调度（定时抓取/回测）、日志与监控、配置管理、容器化

> 注：上面的技术选型为实现建议；本文件**只定义功能与接口**，实现语言与框架可替换。

---

## 4. 数据采集与治理（功能点）

### 4.1 采集功能清单

* 代码表/元数据抓取（市场、板块、上市/退市日期、状态）
* 交易日历抓取（开/休市、节假日）
* K线数据抓取（频率：**日线必选**；分钟线：5m/1m 可选）
* 基础指标（市值、流通市值、换手率、量比、财务摘要等——字段可配置）
* 增量更新（按最近交易日与最近更新时间判定）
* 断点续传与失败重试（指数退避）
* 速率限制与随机UA；IP封禁保护（冷却/熔断）
* 数据质量校验（缺失、极值、涨跌停价一致性、停牌识别）
* 缓存与持久化（本地目录分区；Parquet分区以`freq`/`symbol`/`年月`组织）

### 4.2 数据字典（核心实体与字段，节选）

**Symbols（证券主表）**

| 字段            | 类型        | 说明                          |
| ------------- | --------- | --------------------------- |
| symbol        | TEXT      | 例：600000.SH / 000001.SZ（主键） |
| name          | TEXT      | 证券简称                        |
| board         | TEXT      | 主板/科创/创业/北交所                |
| listed_date   | DATE      | 上市日期                        |
| delisted_date | DATE/NULL | 退市日期                        |
| status        | TEXT      | active/suspended/delisted   |

**OHLCV（K线事实表，分区存储）**

| 字段                  | 类型        | 说明                |
| ------------------- | --------- | ----------------- |
| symbol              | TEXT      | 外键：Symbols.symbol |
| dt                  | DATETIME  | 交易时间戳             |
| open/high/low/close | REAL      | 开/高/低/收           |
| volume/amount       | REAL      | 成交量/额             |
| freq                | TEXT      | D/5m/1m           |
| adj_factor          | REAL/NULL | 复权因子（如使用）         |

**TradingCalendar**

| 字段             | 类型   | 说明     |
| -------------- | ---- | ------ |
| date           | DATE | 日期（主键） |
| is_trading_day | BOOL | 是否交易日  |
| market         | TEXT | CN_A   |

**Fundamentals（可选字段集，配置化）**
如：`pe`, `pb`, `mkt_cap`, `float_mkt_cap`, `turnover`, `industry` 等。

---

## 5. 策略生成与管理（功能点）

### 5.1 策略生成模式

* **规则组合搜索**：从特征库（均线/动量/波动/量价/估值/资金面）自动组合出入场与仓位规则，进行网格/贝叶斯优化
* **进化/符号表达式**：遗传编程或符号回归在指定算子库内演化信号表达式
* **多目标优化**：年化收益、最大回撤、波动率、夏普等的加权目标或帕累托前沿
* **防过拟合**：时间切片（训练/验证/测试）、滚动窗口、跨标的检验、特征泄露扫描、白噪声检验

### 5.2 策略对象要求

* 策略唯一`name`与`version`
* 参数集合`params`（可序列化/可重现）
* 输入：指定标的的OHLCV与可选因子集
* 输出：按时间索引的**交易信号序列**（买/卖/空仓/持仓比例等）
* 风险控制配置：止损、止盈、单票/组合仓位上限、行业/风格约束（可选）

### 5.3 策略仓库与生命周期

* 策略模板登记（元数据、适用市场/频率、依赖特征）
* 训练/验证/测试三段结果存档
* 评估报告（关键指标、鲁棒性、敏感性、稳定性）
* 上架/下架与版本流转（MVP→稳定→废弃）

---

## 6. 回测与组合模拟（功能点）

* **撮合引擎**：支持规则化成交时点（收盘/次日开盘）；T+1、涨跌停不可成交；100股整数手；失败成交回退与日志
* **交易费用**：佣金、印花税（卖出）、过户费（沪市），最小收费门槛
* **滑点模型**：固定bps 或按成交额/波动率函数
* **资金账户**：初始资金、现金余额、保证金（如无融券则忽略）、融资费率（可选）
* **风控**：单票/组合止损止盈、回撤阈值熔断、持仓权重上限、最大持仓数
* **多标的轮动**：信号强度排序/优先级队列/行业分散度约束
* **指标计算**：累计/年化收益、年化波动、最大回撤、回撤恢复时长、夏普/索提诺/卡玛、信息比率、胜率、盈亏比、换手率
* **结果产物**：净值时间序列、回撤曲线、交易流水、持仓快照、指标汇总、月度/年度分解、分组归因（行业/市值）

---

## 7. 仪表盘与报告（功能点）

### 7.1 页面与图表

* **概览**：净值**折线图**（必选）、累计收益、最大回撤、年化收益、夏普；时间/策略/标的筛选
* **策略详情**：信号-价格叠图、持仓权重变化、收益分解、参数与版本信息
* **交易明细**：可分页表格、单笔费用拆分、导出CSV
* **对比分析**：多策略/多标的净值叠加，月度收益热力图，收益分布直方图
* **数据管理**：同步状态、最近更新时间、缓存占用、数据检查结果
* **报告导出**：一键导出HTML/PDF（包含关键图表与表格）

### 7.2 交互与性能

* 全局筛选（日期区间、频率、标的池、策略/版本）
* 客户端/服务端分页与懒加载
* 首屏渲染目标 ≤2 秒（数据与图表量化）

---

## 8. 配置与运行（需求）

* **环境配置**：本地运行、可选 Docker 化沙箱（禁外网或白名单）
* **参数管理**：`.env`/系统配置中心；敏感信息脱敏
* **调度**：定时数据更新、夜间批处理、失败重试队列
* **日志**：按模块与级别记录，关键交易事件与异常可追溯
* **监控**：数据漂移/缺失监控、接口可用性、速率限制命中率
* **存储**：结构化（SQLite/DuckDB）+ 列式（Parquet），支持清理策略与归档

---

## 9. 外部接口契约（REST 风格，无代码）

> 说明：以下为**接口列表与字段说明**，仅文本与表格，不提供示例代码。

### 9.1 健康与系统

**GET `/healthz`**
用途：服务健康检查
返回：`status`（up/down）、`version`、`timestamp`

**GET `/system/stats`**
用途：系统资源与任务统计
返回：CPU/内存、任务队列长度、数据目录大小、最后一次数据同步时间等

---

### 9.2 数据管理

**POST `/data/sync`**
用途：触发数据抓取/增量更新
请求参数（Body）：

* `boards`：列表（主板/创业/科创/北交所），可空=全部
* `freqs`：列表（D/5m/1m）
* `start` / `end`：日期（ISO8601），可空=按增量策略
* `symbols`：可选列表（为空则按board与全市场）
* `force`：布尔（是否忽略缓存强制刷新）

返回：任务`job_id`、预计处理批次、速率设定、已入队标的数量

**GET `/data/sync/{job_id}`**
用途：查询同步进度
返回：队列耗时、已完成标的、失败重试次数、错误摘要

**GET `/data/ohlcv`**
用途：查询K线数据（分页）
查询参数：

* `symbol`、`freq`、`start`、`end`、`page`、`page_size`
  返回：记录集（dt、open/high/low/close、volume/amount、freq）、总条数

**GET `/data/symbols`**
用途：查询证券主表
查询参数：`board`、`status`、`keyword`（名称/代码模糊）
返回：symbol 列表与元数据

**GET `/data/calendar`**
用途：查询交易日历
查询参数：`start`、`end`
返回：日期+是否交易日

---

### 9.3 策略生成与管理

**POST `/strategy/generate`**
用途：自动生成策略候选
请求字段：

* `mode`：`rule_search` / `bayes_opt` / `evolution`
* `feature_space`：使用的特征集合名称或清单
* `objective`：目标函数定义（权重或帕累托）
* `constraints`：仓位/行业/风格等约束
* `validation_scheme`：训练/验证/测试切分与滚动设置
* `universe`：标的池与频率
  返回：`strategy_id`（候选集）、候选数量、预计评估开销

**GET `/strategy/{strategy_id}`**
用途：查看策略候选集概览
返回：候选名称、参数摘要、适用频率、生成时间、评分榜单（验证集）

**POST `/strategy/promote`**
用途：将候选策略固化为版本
请求字段：`candidate_id`、`name`、`version`、`notes`
返回：`registered_strategy_id`

**GET `/strategy/list`**
用途：查询已注册策略
查询参数：`name`/`tag`/`version`/`status`
返回：策略清单与元数据

---

### 9.4 回测与组合模拟

**POST `/backtest/run`**
用途：发起一次回测/组合模拟
请求字段：

* **回测窗口**：`start`、`end`、`freq`
* **标的与权重**：`universe`（symbol 列表或筛选器）、`max_positions`
* **策略引用**：`strategy_ref`（name+version 或 strategy_id）
* **执行规则**：`execution`（成交时点、T+1、滑点bps、失败处理）
* **费用模型**：佣金bps、印花税bps、过户费bps、最低费用
* **风险控制**：单票/组合止损、止盈、权重上限、行业集中度上限
* **资金设定**：`initial_cash`、再平衡周期（如月度/季度）
* **输出配置**：需要的指标与图表清单、是否保存明细
  返回：`run_id`、队列信息、预计耗时等级（S/M/L）

**GET `/backtest/result/{run_id}`**
用途：获取汇总指标与资源位置
返回：总体区间、累计/年化收益、最大回撤、夏普、波动率、换手率、信息比率、文件路径（净值序列、交易流水、持仓快照）

**GET `/backtest/equity/{run_id}`**
用途：获取净值时间序列（供前端画折线图）
返回：`dt`、`nav`、`drawdown`（可选）

**GET `/backtest/trades/{run_id}`**
用途：交易明细分页
查询参数：`page`、`page_size`、`symbol`
返回：`dt`、`symbol`、`side`、`qty`、`price`、`fee`、`tax`、`slippage`、`reason`

**GET `/backtest/positions/{run_id}`**
用途：持仓快照分页
返回：`dt`、`symbol`、`qty`、`cost`、`market_value`、`pnl`

**GET `/backtest/decomposition/{run_id}`**
用途：收益分解
返回：月度/年度收益表、行业/市值分组表现

---

### 9.5 报告与导出

**POST `/report/export`**
用途：生成本次回测报告
请求字段：`run_id`、`format`（HTML/PDF/CSV）、`sections`（图表/表格清单）
返回：报告文件路径、生成耗时、文件大小

**GET `/export/trades`**
用途：导出交易流水CSV
查询参数：`run_id`、`symbol`（可选）
返回：下载链接与摘要

---

### 9.6 任务与调度

**POST `/jobs/schedule`**
用途：创建周期任务（如每日收盘后数据更新与回测）
请求字段：`type`（data_sync/backtest）、`cron` 表达式、参数模板、启停状态
返回：`job_id`

**GET `/jobs/{job_id}` / DELETE `/jobs/{job_id}`**
用途：查询/删除任务

---

## 10. 前端仪表盘（UI/UX 要求）

* **布局**：左侧筛选栏（策略/版本、标的池、日期、频率），右侧多页签视图
* **核心图表**：净值**折线图**（可区间缩放）、回撤曲线、收益分布直方图、月度热力图
* **表格**：交易明细、持仓快照、指标概览（支持列筛选与导出）
* **交互**：多策略叠加比较、参数版本切换、区间拖拽缩放
* **状态反馈**：数据同步与回测任务状态、错误摘要、数据新鲜度
* **可访问性**：深色/浅色主题、单位与千分位格式化、时间时区显示（默认 Asia/Singapore，可切换）

---

## 11. 非功能性要求

* **性能目标**

  * 1000支股票10年日线数据增量更新 ≤10分钟（含缓存/分区写入）
  * 单策略单标的10年日线回测 ≤3秒；100支轮动 ≤30秒（同等硬件）
  * 仪表盘首屏渲染 ≤2秒

* **可靠性与可恢复**

  * 抓取失败自动重试（指数退避），超过阈值熔断与人工介入提示
  * 结果可重现（固定随机种子、版本与参数落档）

* **安全与合规**

  * 遵循目标网站条款与 robots；频控、缓存与离线优先
  * 本地存储，数据不外泄；敏感配置脱敏

* **监控与审计**

  * 指标：抓取成功率、速率限制命中率、缺失/异常记录数
  * 日志级别：INFO（流程）/WARN（回退）/ERROR（失败）/AUDIT（撮合与成交）

---

## 12. 测试与验收

* **测试范围**

  * 数据层：字段解析一致性、涨跌停价校验、增量更新正确性
  * 策略生成：参数空间边界、过拟合防护验证（OOS稳定性阈值）
  * 回测引擎：T+1、整数手、费用/滑点、停牌/涨跌停的撮合边界
  * 指标正确性：与已知样例对比（夏普、最大回撤等）
  * 仪表盘：加载性能、筛选正确性、导出文件完整性
  * 报告：内容齐全、格式合规、可追溯

* **验收标准（DoD）**

  * 指定标的池（≥300）可一键增量更新
  * 至少两种自动策略生成模式（规则搜索+贝叶斯或进化）
  * 回测满足本章全部仿真约束
  * 提供净值折线图、关键指标、交易/持仓明细，并可导出
  * 任务调度可用，日志完备，错误可追溯
  * 接口文档（本方案）与字段字典完整

---

## 13. 运维与部署

* **部署形态**：本地直跑或 Docker（API + UI + 存储卷）
* **环境隔离**：沙箱运行（可禁外网，仅开放必要的目标域）
* **配置**：统一配置中心/环境变量；分环境（dev/test/prod）
* **备份与归档**：历史 Parquet 与数据库按月归档，滚动保留策略
* **容量规划**：磁盘占用评估（按标的数量×频率×年限），预警阈值

---

## 14. 交付物清单

* 本《技术与需求方案》（Markdown）
* 接口字段字典与错误码清单（随API文档）
* 数据字典（实体关系、字段含义、单位/取值范围）
* 任务与监控说明（数据更新、回测批处理）
* 用户手册（仪表盘操作与报告导出）
* 合规模块说明（频控与缓存策略、免责声明模板）

---

## 15. 里程碑（示意）

1. **M1**：数据层可用（代码表/日线/日历、缓存、增量）；接口 `/data/*` 完成
2. **M2**：回测引擎 MVP（T+1、涨跌停、整数手、费用/滑点）；接口 `/backtest/run` 与结果查询
3. **M3**：策略自动生成（规则搜索+一种优化方式）；策略登记与版本管理
4. **M4**：仪表盘 MVP（净值折线、指标、交易明细）；导出CSV
5. **M5**：报告导出（HTML/PDF）、对比分析、月度热力图；调度与监控完善
6. **M6**：性能优化与稳健性提升；完整验收与文档收尾

---

## 16. 错误码与返回约定（示例纲要）

| 错误码        | 含义    | 典型场景      | 处理建议       |
| ---------- | ----- | --------- | ---------- |
| `E-DS-429` | 采集被限流 | 触发速率限制/封禁 | 降速、延迟重试、熔断 |
| `E-DS-404` | 数据缺失  | 交易日无数据/退市 | 标注缺失、跳过撮合  |
| `E-BT-406` | 撮合失败  | 涨跌停/停牌    | 记录失败、顺延处理  |
| `E-ST-400` | 策略非法  | 参数越界/特征缺失 | 返回可解释错误消息  |
| `E-RP-500` | 报告失败  | 资源不足/模板错误 | 释放资源、重试/降级 |

---

## 17. 术语表

* **OOS**：Out-of-Sample，样本外验证
* **bps**：基点，1 bps = 0.01%
* **NAV**：净值（初始=1.0 或按初始资金归一）
* **帕累托前沿**：多目标最优集

---

### 结语

以上为**完整功能与接口方案（无代码）**。若需要，我可以把该文档拆分为：API 字段字典（更细粒度表格）、任务运行手册、合规规范说明，便于直接落库到你的项目维基/知识库。
