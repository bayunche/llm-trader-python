下面是优化后的**“LLM‑First A股交易机器人”功能与字段级详细设计**。
按“**功能说明 → 字段定义 → 规则与约束 → 验收标准**”组织，**不包含代码与示例**，可直接指导团队实施。

---

## 1. 范围与目标

**范围**

* 大模型直接做出下单决策（Actor），Checker 仅作结构/一致性/可执行性审查，Risk Gate 提供硬风控。
* 覆盖：数据接入、观测生成、LLM 决策与审查、硬风控、撮合执行（沙箱/实盘）、审计留痕、仪表盘、配置中心、统一启动、容器化部署。

**目标**

* 决策链路可追溯（观测→Actor→Checker→风控→委托→成交→PnL）。
* 模型/端点/提示词与风控参数可在线热更新。
* 实现沙箱与实盘一致的执行接口与审计格式。

**不在范围**

* 投研回测引擎的完整实现；第三方数据商业授权谈判。

---

## 2. 角色与术语

* **Actor**：大模型执行体，直接产出交易动作。
* **Checker**：审单官（可为 LLM 或规则），验证动作的结构、取值域、时效与一致性。
* **Risk Gate**：硬风控（交易所与账户规则），唯一可拦截执行的非模型环节。
* **Observation**：本次决策所依据的结构化市场/账户/风险信息快照。
* **BrokerAdapter**：券商/沙箱的统一适配层。
* **Decision Ledger**：决策总账，记录全链路。
* **主表（Master Table）**：证券静态与基础指标的标准化集合。

---

## 2.5 技术栈与基础设施

* **后端**：Python 3.10 + FastAPI，异步驱动；模型调用统一走自建 OpenAI 兼容网关。
* **数据库**：PostgreSQL 15+（可按需启用 TimescaleDB/pgvector 扩展），以 SQLModel + Alembic 管理 Schema 与迁移。
* **缓存与队列**：Redis 作为短期缓存、幂等令牌与任务队列过期存储。
* **前端**：React / Next.js 仪表盘，通过 REST/WebSocket 获取数据，嵌入 LLM 日志与观测面板。
* **容器化**：Docker Compose 统一编排 API、任务调度、仪表盘、PostgreSQL、Redis、可选模型服务；统一启动脚本控制启停与健康检查。
* **监控与日志**：Prometheus/OpenTelemetry 采集基础指标，按详细方案定义的成本、延迟、成功率指标暴露给仪表盘与告警系统。

---

## 3. 功能清单（带验收）

| 代号    | 功能名称              | 核心说明                                        | 优先级 | 验收标准                                   |
| ------- | ----------------- | ------------------------------------------- | ---- | -------------------------------------- |
| MG‑01   | OpenAI 兼容模型网关    | `/v1/chat/completions` 转发、权重路由、熔断、计费观察        | P0   | 支持本地 Ollama 与 ≥1 云端端点；延迟/成本指标入库           |
| MG‑02   | 动态模型端点配置         | 在线增删端点、模型别名映射、温度/超时/重试策略                | P0   | `GET/PUT /api/config/models` 生效，无需重启     |
| MD‑01   | 主表采集与标准化        | 日级全量 + 小时增量，幂等入库并维护版本                        | P0   | 字段完整率 ≥99%，重复导入无脏数据                     |
| MD‑02   | 行情接入（轮询/WS）      | 分钟线必备、逐笔可选，断线重连，时间对齐                        | P0   | 分钟线滞后 ≤2s，断线自动恢复                          |
| OBS‑01  | 观测生成器              | 聚合主表/行情/账户/风险，构建轻量 Observation JSON         | P0   | 单次构建 ≤50ms（缓存命中）；过期自动拒用                 |
| ACT‑01  | Actor 决策            | 基于观测输出动作 JSON（place/modify/cancel/no_op）         | P0   | 非法结构率 <0.5%；P95 延迟≤1.5s（云）/≤800ms（本地） |
| CHK‑01  | Checker 审单          | 结构/取值/时效/冲突检查；支持规则版与 LLM 版                    | P0   | 误放行≈0；超时 fail-safe                          |
| RK‑01   | 硬风控                 | 价格笼子、涨跌停、T+1、单位、现金、集中度等硬约束                | P0   | 违规单全部拒绝并记录原因                              |
| EX‑01   | 执行控制层             | 下单/撤单/改单幂等处理，失败重试，状态回补                         | P0   | 下单成功率 ≥99%；幂等键阻止重复下单                     |
| SB‑01   | 沙箱撮合引擎            | 模拟 T+1、涨跌停、最小单位、部分成交与撤单延迟                     | P0   | 回测对比通过率 ≥95%                                 |
| BR‑01   | 券商适配层             | 至少一家实盘券商适配，中性化错误码，降级重试                       | P0   | 关键错误可判定并触发重试/降级                          |
| AUD‑01  | 决策总账               | 观测→决策→审查→风控→执行→成交全链路审计                          | P0   | 100% 决策可追溯，支持按日/按决策导出                   |
| CFG‑01  | 配置中心               | 模型端点、提示词模板、风控参数版本化管理与灰度                     | P0   | 修改即时生效并记录变更审计                            |
| UI‑01   | 仪表盘                 | 净值、回撤、胜率、活跃度、费用、决策时间线、模型调用日志             | P0   | 秒级刷新，历史可检索，支持导出                          |
| ADM‑01  | 统一启动与健康管理         | 组件启停、健康/状态查询、模式切换                                 | P0   | 启停安全有序；健康检查项全绿                           |
| DEP‑01  | 容器化交付             | Docker Compose 一键部署，多服务健康探针                            | P0   | 首次部署可启动全栈；密钥不落盘明文                       |
| TEST‑01 | 自动化测试与验证         | 单元、集成、冒烟测试；覆盖 LLM 决策链、风控、执行、仪表盘             | P0   | pytest 通过；冒烟脚本验证关键链路                       |
| RUN‑01  | 运维与运行手册          | Runbook、告警策略、模式切换流程、应急预案                           | P0   | Runbook 覆盖常见故障，演练通过                        |

---

## 4. 端到端流程（文字化时序）

1. 数据层更新：主表与行情落地；账户/持仓/风险姿态入库。
2. 生成观测：以交易时钟与订阅规则形成本次决策的 Observation。
3. Actor 决策：基于 Observation 输出动作集合。
4. Checker 审核：校验结构/取值域/一致性/时效/冲突。
5. Risk Gate：按市场与账户硬规则做最终许可。
6. 执行：统一接口将动作转化为委托；回报入库并推送前端。
7. 审计：将完整链路写入 Decision Ledger；指标归集并可视化。

---

### 4.1 架构组件概览

* **数据域**：主表采集器、行情接入器、Observation Builder；均写入 PostgreSQL，并通过 Redis 维持热缓存与并发幂等。
* **决策域**：Model Gateway、Actor Service、Checker Service；共享提示词模板与模型配置，所有调用日志写入 LLM 调用审计表。
* **风控与执行域**：Risk Gate 引擎、Execution Controller、Broker Adapter、Sandbox Engine，提供统一订单状态机与回报回补。
* **审计与可视化域**：Decision Ledger 服务、报表生成器、Streamlit/Next.js 仪表盘，展示指标、决策时间线与 LLM 日志。
* **运维域**：配置中心、统一启动与健康 API、监控告警、Docker Compose 编排脚本及 Runbook。

---

## 5. 字段级设计

### 5.1 观测（Observation）字段

**用途**：给 Actor 与 Checker 使用的单次决策依据快照；带有效期。

| 字段                                       | 类型   | 约束/说明                                              |
| ---------------------------------------- | ---- | -------------------------------------------------- |
| observation_id                           | 字符串  | 全局唯一；参与审计关联                                        |
| generated_at                             | 日期时间 | ISO 8601；系统时间                                      |
| valid_ttl_ms                             | 整数   | 观测有效期，超期拒用                                         |
| clock.phase                              | 枚举   | pre_open / continuous_trading / close / off_market |
| account.nav                              | 数值   | 当前权益                                               |
| account.cash                             | 数值   | 可用资金                                               |
| account.risk_posture                     | 枚举   | normal / cautious / flat_only / kill_switch        |
| positions[]                              | 数组   | 当前持仓清单，见下                                          |
| positions[].symbol                       | 字符串  | 交易代码（含交易所后缀）                                       |
| positions[].qty                          | 数值   | 持仓数量                                               |
| positions[].avg_price                    | 数值   | 持仓均价                                               |
| universe[]                               | 数组   | 本轮可操作标的集合                                          |
| features.<symbol>.last                   | 数值   | 最新价                                                |
| features.<symbol>.bid1/ask1              | 数值   | 买一/卖一                                              |
| features.<symbol>.ret_5m                 | 数值   | 5分钟收益率                                             |
| features.<symbol>.vol_ratio_5m           | 数值   | 5分钟量比                                              |
| features.<symbol>.beta                   | 数值   | 相对基准波动                                             |
| features.<symbol>.liq_rank               | 数值   | 流动性分位[0,1]                                         |
| features.<symbol>.risk_flags[]           | 枚举数组 | 停牌风险/逼近涨停等标签                                       |
| features.<symbol>.news_flags[]           | 枚举数组 | 正面/负面/中性/传闻等                                       |
| market_rules.<symbol>.tick_size          | 数值   | 最小变动价位                                             |
| market_rules.<symbol>.lot_size           | 整数   | 最小交易单位                                             |
| market_rules.<symbol>.price_band.up/down | 数值   | 当日涨跌停价格                                            |

**校验规则**

* generated_at + valid_ttl_ms 未过期；
* universe 至少含 1 个可交易标的；
* market_rules 必须包含所有 universe 成员的 tick/lot/price_band。

---

### 5.2 Actor 输出（Decision/Actions）字段

**用途**：Actor 的一次决策与动作集合；Checker/Risk/执行依此展开。

| 字段                           | 类型    | 约束/说明                                             |
| ---------------------------- | ----- | ------------------------------------------------- |
| decision_id                  | 字符串   | 全局唯一；与审计关联                                        |
| timestamp                    | 日期时间  | ISO 8601                                          |
| observations_ref             | 字符串   | 引用 observation_id                                 |
| account_view.nav/cash        | 数值    | Actor 决策时看到的账户快照                                  |
| global_intent.risk_posture   | 枚举    | 可为空；对本轮姿态的建议                                      |
| global_intent.max_new_margin | 数值    | 新占用资金上限，非必填                                       |
| notes                        | 字符串   | ≤ 500 字的简述                                        |
| actions[]                    | 数组    | 动作集合（至少 1 个）                                      |
| actions[].type               | 枚举    | place_order / modify_order / cancel_order / no_op |
| actions[].symbol             | 字符串   | 涉及标的（no_op 可为空）                                   |
| actions[].side               | 枚举    | buy / sell（仅下单类必填）                                |
| actions[].order_type         | 枚举    | limit / market（下单/改单）                             |
| actions[].price              | 数值或空  | 市价为空；限价必填                                         |
| actions[].qty                | 整数或空  | 按 lot_size 的整数倍                                   |
| actions[].tif                | 枚举    | day / ioc / fok（可配置是否支持）                          |
| actions[].target_order_id    | 字符串或空 | 改单/撤单目标                                           |
| actions[].intent.rationale   | 字符串   | ≤ 240 字，中文或中英                                     |
| actions[].intent.confidence  | 数值    | [0,1]                                             |

**校验规则**

* actions 至少包含一个动作；
* 限价单 price > 0 且落在 price_band 内；
* qty 为 lot_size 的整数倍且 > 0；
* 同一 decision 中动作不得互相逻辑冲突（如同时对同一订单又改又撤）。

---

### 5.3 Checker 输出字段

| 字段                  | 类型   | 约束/说明        |
| ------------------- | ---- | ------------ |
| pass                | 布尔   | 通过/不通过       |
| reasons[]           | 数组   | 不通过原因集合（可多）  |
| checked_at          | 日期时间 | ISO 8601     |
| observation_expired | 布尔   | 观测是否过期       |
| conflicts[]         | 数组   | 动作间冲突列表（适用时） |

**判定原则**

* 超时未产出结果视为不通过；
* 涉及结构/取值域/时效/一致性/冲突的任一项异常即为不通过。

---

### 5.4 Risk Gate 输入/输出字段

**输入**：Checker 通过后的决策动作、账户快照、风控配置、市场规则。
**输出字段**

| 字段            | 类型   | 说明                   |
| ------------- | ---- | -------------------- |
| pass          | 布尔   | 通过/不通过               |
| reasons[]     | 数组   | 拒绝原因（如价格笼子、现金不足、T+1） |
| corrections[] | 数组   | 仅记录可行的修正建议（不自动改）     |
| evaluated_at  | 日期时间 | 时间戳                  |

**硬规则字段（配置中心管理）**

* 价格相关：price_band、价格笼子容差%、tick_size 对齐方式。
* 成交量/流动性：当日标的成交量占比上限、滑点估计上限（bps）。
* 持仓集中度：单标的最大仓位（%NAV）、行业/板块集中度上限。
* 资金安全：单笔最大委托额、单日净买入上限。
* 合规清单：停牌/退市/风险警示/ST/黑名单。
* 交易时段：允许开仓/仅平/禁新开（按时段与开关）。
* T+1：卖出规则检查。
* 熔断：Kill‑Switch、只平不开。

---

### 5.5 执行（Execution）与订单/成交字段

**订单（Order）**

| 字段              | 类型     | 说明                                                                   |
| --------------- | ------ | -------------------------------------------------------------------- |
| order_id        | 字符串    | 全局唯一（适配器映射）                                                          |
| client_order_id | 字符串    | 幂等键；重复提交过滤                                                           |
| decision_id     | 字符串    | 来源决策关联                                                               |
| symbol          | 字符串    | 标的                                                                   |
| side            | 枚举     | buy / sell                                                           |
| order_type      | 枚举     | limit / market                                                       |
| price           | 数值或空   | 市价为空                                                                 |
| qty             | 整数     | lot_size 整数倍                                                         |
| tif             | 枚举     | day / ioc / fok                                                      |
| status          | 枚举     | created / accepted / partially_filled / filled / canceled / rejected |
| broker          | 枚举/字符串 | sandbox / <券商代号>                                                     |
| placed_at       | 日期时间   | 委托时间                                                                 |
| risk_passed     | 布尔     | 风控是否通过                                                               |
| risk_detail     | 结构     | 风控校验详情摘要                                                             |

**成交（Fill）**

| 字段        | 类型   | 说明   |
| --------- | ---- | ---- |
| fill_id   | 字符串  | 全局唯一 |
| order_id  | 字符串  | 订单关联 |
| symbol    | 字符串  | 标的   |
| qty       | 数值   | 成交数量 |
| price     | 数值   | 成交价格 |
| fee       | 数值   | 费用与税 |
| filled_at | 日期时间 | 成交时间 |

**状态机要求**

* created → accepted → partially_filled → filled（或 canceled/rejected）
* ioc/fok 的特例处理符合各自时效规则。

---

### 5.6 决策总账（Decision Ledger）字段

| 字段               | 类型   | 说明                                                     |
| ---------------- | ---- | ------------------------------------------------------ |
| decision_id      | 字符串  | 主键                                                     |
| obs_ref          | 字符串  | 观测引用                                                   |
| actor_model      | 字符串  | 决策所用模型名                                                |
| checker_model    | 字符串  | 审单所用模型名/规则                                             |
| actor_json_ref   | 字符串  | Actor 原始输出存证位置标识                                       |
| checker_json_ref | 字符串  | Checker 原始输出存证位置标识                                     |
| risk_summary     | 结构   | 风控结果与要点                                                |
| status           | 枚举   | executed / rejected_checker / rejected_risk / canceled |
| created_at       | 日期时间 | 决策生成时间                                                 |
| executed_at      | 日期时间 | 首次委托时间（执行成功时）                                          |

---

### 5.7 模型调用审计字段

| 字段                | 类型   | 说明              |
| ----------------- | ---- | --------------- |
| trace_id          | 字符串  | 调用链路标识          |
| role              | 枚举   | actor / checker |
| provider          | 字符串  | 提供方代号           |
| model             | 字符串  | 模型标识            |
| prompt_hash       | 字符串  | 输入哈希（敏感脱敏）      |
| tokens_prompt     | 整数   | 提示 token        |
| tokens_completion | 整数   | 输出 token        |
| latency_ms        | 整数   | 延迟              |
| cost              | 数值   | 估算费用            |
| created_at        | 日期时间 | 时间戳             |

---

### 5.8 主表（证券基础信息）字段

| 字段             | 类型  | 说明           |
| -------------- | --- | ------------ |
| symbol         | 字符串 | 主键，含交易所后缀    |
| exchange       | 枚举  | SSE / SZSE 等 |
| board          | 枚举  | 主板/创业板/科创板等  |
| name           | 字符串 | 证券简称         |
| is_st          | 布尔  | 风险警示         |
| list_date      | 日期  | 上市日期         |
| industry       | 字符串 | 行业           |
| market_cap     | 数值  | 总市值          |
| float_cap      | 数值  | 流通市值         |
| pe_ttm / pb    | 数值  | 估值指标         |
| tick_size      | 数值  | 最小变动价位       |
| lot_size       | 整数  | 最小交易单位       |
| trading_status | 枚举  | 正常/停牌/退市等    |
| as_of_date     | 日期  | 数据快照日期       |
| version        | 整数  | 版本号          |

---

### 5.9 绩效与账户字段（仪表盘统计支撑）

**账户快照**：时间、NAV、现金、可用。
**日度绩效**：交易日、期末 NAV、当日 PnL、最大回撤、胜率。
**统计口径**

* 胜率：有盈亏闭环的交易单计数；
* 费用：佣金+千分税费等；
* 活跃度：单位时间内委托/成交/撤单数量。

---

## 6. 配置中心字段设计

### 6.1 模型端点配置

| 字段                          | 类型  | 说明                     |
| --------------------------- | --- | ---------------------- |
| model_alias                 | 字符串 | 对外暴露模型名（用于调用）          |
| provider                    | 字符串 | 提供方标识                  |
| endpoint_url                | 字符串 | 兼容 OpenAI 的地址          |
| auth_type                   | 枚举  | api_key / none / other |
| auth_secret_ref             | 字符串 | 密钥引用标识（不明文存储）          |
| default_params.temperature  | 数值  | 0–2                    |
| default_params.timeout_ms   | 整数  | 超时                     |
| retry.max_attempts          | 整数  | 最大重试                   |
| routing.weight              | 数值  | 0–1；权重路由               |
| circuit_breaker.enabled     | 布尔  | 熔断开关                   |
| circuit_breaker.rules       | 结构  | 错误率/延迟阈值与恢复策略          |
| cost_estimate.per_1k_tokens | 数值  | 成本监控                   |
| enabled                     | 布尔  | 是否可被路由                 |

### 6.2 提示词模板管理

| 字段                      | 类型  | 说明                                |
| ----------------------- | --- | --------------------------------- |
| template_id             | 字符串 | 主键                                |
| role                    | 枚举  | actor / checker                   |
| version                 | 字符串 | 语义化版本                             |
| locale                  | 枚举  | zh_CN 等                           |
| variables[]             | 数组  | 可注入变量名列表                          |
| guardrails              | 结构  | 输出格式与边界要求摘要                       |
| publish_status          | 枚举  | draft / staged / active / retired |
| rollout_strategy        | 结构  | 灰度比例/流量分配                         |
| change_log              | 字符串 | 版本说明                              |
| created_by / updated_by | 字符串 | 责任人                               |

### 6.3 风控参数

| 字段                        | 类型 | 说明                                          |
| ------------------------- | -- | ------------------------------------------- |
| limits.price_collar_pct   | 数值 | 价格笼子容差（%）                                   |
| limits.single_order_cap   | 数值 | 单笔委托额上限                                     |
| limits.daily_net_buy_cap  | 数值 | 单日净买入上限                                     |
| limits.symbol_nav_cap     | 数值 | 单标的仓位上限（% NAV）                              |
| limits.industry_nav_cap   | 数值 | 行业仓位上限                                      |
| limits.vol_impact_cap_bps | 数值 | 预估滑点上限（bps）                                 |
| lists.blacklist[]         | 数组 | 黑名单标的                                       |
| lists.whitelist[]         | 数组 | 白名单标的（可选）                                   |
| market_rules.t_plus_one   | 布尔 | 是否启用 T+1 卖出检查                               |
| posture.mode              | 枚举 | normal / cautious / flat_only / kill_switch |
| posture.schedule[]        | 数组 | 按时段的姿态策略                                    |

---

## 7. 接口与事件（无代码、仅字段契约）

### 7.1 管理与健康

* **启动**
  输入字段：components[]（ingestor/trader/frontend 等）、mode（shadow/copilot/autopilot_strict）、requested_by。
  输出字段：accepted（布尔）、started_components[]、warnings[]、timestamp。

* **停止**
  输入字段：components[]、graceful（布尔）、requested_by。
  输出字段：stopped_components[]、remaining_tasks[]、timestamp。

* **健康**
  输出字段：status（ok/degraded/down）、dependencies[]（名称/状态/延迟/错误率）、last_updated。

* **状态**
  输出字段：execution_mode、decision_rate（每分钟）、reject_rate_by_stage（checker/risk）、latency_p95_by_stage、model_cost_today、alerts_open。

### 7.2 决策执行（同步编排）

* **发起决策**
  输入字段：observations（引用或内联）、execution_mode、actor_model（可选）、checker_model（可选）、request_id。
  输出字段：decision_id、actor_result（结构）、checker_result（结构）、risk_result（结构）、orders[]（下发成功的订单摘要）、warnings[]。

* **回传反馈**
  输入字段：decision_id、orders[]（订单状态变化）、fills[]、account_delta（资金/持仓变化）。
  输出字段：accepted（布尔）、updated_entities[]。

### 7.3 配置中心

* **模型配置读写**
  输入字段（写入）：见“模型端点配置”表。
  输出字段：变更前后差异摘要、版本号、operator、applied_at。

* **提示词模板读写**
  输入字段（写入）：见“提示词模板管理”表。
  输出字段：版本与灰度状态、影响面清单。

* **风控参数读写**
  输入字段（写入）：见“风控参数”表。
  输出字段：启用范围、变更风险提示。

### 7.4 数据访问

* **净值曲线**
  输入字段：from、to、granularity（日/小时/分钟）。
  输出字段：时序点列表（时间、NAV、PnL、回撤）。

* **交易统计**
  输入字段：window（7d/30d/自定义）、group_by（策略/标的/时段）。
  输出字段：胜率、盈亏分布、成交/撤单率、费用、活跃度。

* **审计查询**
  输入字段：decision_id 或按时间/标的/状态查询条件。
  输出字段：观测摘要、Actor/Checker/Risk 结论、订单与成交链路、模型调用摘要、费用与延迟指标。

### 7.5 实时事件（WebSocket）

事件类型与字段：

* actor_decision：decision_id、observations_ref、actions[]、confidence_stats。
* checker_result：decision_id、pass、reasons[]。
* risk_result：decision_id、pass、reasons[]。
* order_update：order_id、status、reason（可选）、remaining_qty。
* fill：order_id、fill_id、qty、price、fee、filled_at。
* pnl_update：ts、nav、intraday_pnl。
* alert：severity、category（数据/模型/风控/券商）、message、ts。

---

## 8. 前端仪表盘与视图字段

### 8.1 总览页

* 顶部指标：当前 NAV、当日/当周 PnL、最大回撤、胜率、活跃度、费用占比。
* 曲线：资金权益曲线（NAV）、当日 PnL 曲线。
* 卡片：风险姿态（posture）、拒单分布（按 stage 与原因）。

### 8.2 决策时间线

* 维度：按 decision_id 展示节点与耗时。
* 节点字段：actor_decision（动作数量、置信度分布）、checker_result、risk_result、orders/ fills（序列化）、最终状态。
* 交互：点击节点展开对应的字段明细（原始存证引用不可编辑）。

### 8.3 持仓与暴露

* 字段：symbol、市值、仓位占比、行业、浮动盈亏、Beta、集中度，账户现金与可用。
* 图表：行业/板块暴露树图、TopN 持仓条形、集中度仪表。

### 8.4 模型观测

* 指标：tokens、调用次数、平均/分位延迟、错误率、成本；按模型/提供方维度。
* 诊断：熔断次数、切换原因、超时占比。

### 8.5 配置中心

* 模型列表：alias、provider、启用状态、权重、SLA、成本。
* 提示词模板：role、version、状态、灰度覆盖、变更记录。
* 风控参数：限额/清单/姿态日程；变更审计与恢复点。

---

## 9. 错误码与告警

### 9.1 中性错误码（执行/风控/数据）

* BROKER_TIMEOUT / BROKER_REJECT_PRICE_LIMIT / BROKER_RATE_LIMIT
* RISK_PRICE_BAND / RISK_INSUFFICIENT_CASH / RISK_TPLUS1 / RISK_POSITION_CAP
* CHECKER_SCHEMA_FAIL / CHECKER_CONFLICT / OBS_EXPIRED
* DATA_FEED_DELAY / DATA_MISSING_SYMBOL / DATA_MKT_RULES_MISMATCH
* MODEL_TIMEOUT / MODEL_PARSE_FAIL / CIRCUIT_BREAKER_OPEN

每个错误码需包含：时间、上下文（decision_id/order_id）、严重级别、建议动作（人工/自动）。

### 9.2 告警分类与字段

* 分类：数据、模型、风控、券商、系统。
* 字段：alert_id、severity、category、message、first_seen、last_seen、count、owner、status（open/ack/closed）。

---

## 10. 非功能指标（SLO）

* 决策端到端时延（观测→委托）：本地模型 P95 ≤ 800ms；云模型 P95 ≤ 1.5s。
* 观测滞后：分钟线 ≤ 2s。
* 决策质量：非法动作在风控前拦截率≥99.5%；Checker 误放行≈0。
* 可用性：核心服务 99.9%。
* 审计覆盖：100% 决策可追溯到观测与调用。
* 配置变更生效：≤ 5s（强一致语义除外）。
* 成本治理：单位收益的 token 成本逐期下降（通过观测面板追踪）。

---

## 11. 安全与合规要求

* 合规：交易所规则（涨跌停、价格笼子、T+1、最小单位）作为硬规则不可关闭。
* 隐私：密钥仅以安全引用方式存储与调用；日志脱敏；提示词敏感变量屏蔽显示。
* 权限：RBAC（管理员/交易员/观察员），配置与审计导出需审批。
* 运行模式：shadow → copilot → autopilot_strict 的渐进放量与额度限制。
* 紧急：Kill‑Switch、只平不开；系统故障自动降级为 shadow。

---

## 12. 实施与交付物（无代码）

**交付物列表**

* 字段字典（本文所列的所有实体、接口、事件字段）；
* 错误码字典与告警规则集；
* SLO 指标看板定义；
* 运行模式与切换流程文档；
* 审计导出格式定义（按决策与按日两套）；
* 配置变更流程与审批表；
* 灰度发布计划（模板与回滚标准）；
* 安全检查清单（密钥、权限、日志脱敏、审计留存期限）。

**实施顺序（阶段）**

1. P0（闭环最小可用）：主表/行情→观测→Actor/Checker→风控→沙箱执行→审计→仪表盘总览+时间线；
2. P0 完善：幂等/重试、中性错误码、配置中心、告警与健康；
3. P1：券商适配、模型观测面板、灰度模板；
4. 实盘小流量：copilot 下高置信度自动执行，设置额度与风控阈值；
5. 扩容与优化：成本/延迟/稳定性治理。

---

## 13. 测试计划与验收标准

* **测试层级**：单元（字段校验、风控规则、模型配置）、集成（观测→决策→风控→执行链路）、冒烟（Compose 全栈启动后执行一次完整循环）、性能回归（模型调用、订单吞吐）、回归基线（沙箱与实盘接口一致性）。
* **测试数据**：覆盖涨停、资金不足、T+1、黑名单、停牌等场景；提供真实/模拟行情序列与账户快照；构造多种 LLM 响应质量样本。
* **自动化要求**：pytest 全量通过；本地 `scripts/run_tests.sh` 聚合冒烟结果；所有测试输出写入 `verification.md` 与 `.codex/testing.md`；禁止依赖外部 CI。
* **验收标准**：关键链路成功率 ≥99%；Actor/Checker 非法结构率 <0.5%；风控拒单命中率 100%；仪表盘展示数据与 Decision Ledger 一致。
* **观测指标**：执行时长、队列积压、模型调用成本、API 成功率、告警触发频次（按《详细方案.md》测试章节定义）。

---

## 14. 上线与运行手册摘要

* **启动流程**：`start.sh up` → `scripts/init_db.py` 迁移 → 导入模型/风控/提示词配置 → shadow 模式冒烟 → 切换 copilot / autopilot。
* **运行模式切换**：shadow（只观测）、copilot（人工确认/额度限制）、autopilot_strict（全自动）；切换需更新 `SystemState` 并记录责任人。
* **监控与告警**：Prometheus 采集时延/错误率/成本，Grafana 展示；PagerDuty/钉钉接收分级告警；熔断、风控拒单、订单失败等关键事件实时通知。
* **应急预案**：Kill-Switch、只平仓模式、模型熔断退回、Redis 缓存清除、订单回溯；Runbook 列明步骤、负责人与恢复时间目标。
* **变更管理**：配置中心提供草稿→灰度→全量流程；双人复核；部署采用蓝绿或滚动策略并保留回滚点；所有变更写入 Decision Ledger。

---

### 一句话结论

以上文档将系统拆解为可执行的“功能‑字段‑规则‑验收”单元，覆盖观测、决策、审查、风控、执行、审计、可视化与配置全链条。团队按此即可对照实现与验收，无需参考任何代码示例。
