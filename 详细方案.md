下面给出 **“LLM‑First 交易机器人（A股）”完整功能与详细设计文档**。
目标：工程团队可按本文直接实施（从建库、接口到部署、测试、验收一条龙）。
默认语言/技术栈：**Python(FastAPI) + PostgreSQL(+Timescale/pgvector) + Redis + React/Next.js + Docker Compose**。
执行模式：以 **大模型 Actor 直接做出下单决策**（Checker+硬风控把关），策略仅作记录和审计。

---

## 目录

1. [范围与目标](#scope)
2. [术语与角色](#glossary)
3. [功能清单（带优先级与验收标准）](#features)
4. [总体架构与流程](#architecture)
5. [详细设计（模块分解）](#design)
6. [数据模型（DDL）](#data)
7. [API 设计（REST/WS/OpenAI兼容）](#api)
8. [LLM 提示词与 JSON Schema（可直接落地）](#prompts)
9. [前端仪表盘设计](#frontend)
10. [部署与运维（Docker 一键、统一启动端点、观测）](#devops)
11. [测试计划与验收标准](#testing)
12. [安全、风控与合规](#risk)
13. [实施计划、WBS、RACI](#plan)
14. [上线与运行手册（Runbook）](#runbook)

---

## 1) 范围与目标 <a id="scope"></a>

* **范围**：A股自动化交易系统，涵盖数据接入、选股/观察、LLM 决策（下单/撤单/改单）、硬风控、撮合执行（沙箱与实盘）、全链路审计、仪表盘、配置中心、统一启动与一键部署。
* **目标**：

  * 大模型**直接参与实盘下单**（Actor 说了算），策略仅为审计记录。
  * 任何执行前必须通过 **Trader Checker（审单官）+ 硬风控**。
  * 强可追溯：观测→决策→审查→风控→委托→成交→PnL 全链路。
  * 可插拔：数据源、券商 API、模型端点、提示词模板均可热切换。

---

## 2) 术语与角色 <a id="glossary"></a>

* **Actor（LLM 执行体）**：接收观测，直接输出“动作 JSON”（下单/撤单/改单/no_op）。
* **Checker（LLM 审单官/或规则版）**：检查 Actor 输出的**结构/一致性/可执行性**；不做观点判断。
* **Risk Gate（硬风控）**：合规与交易所规则（价格笼子、涨跌停、T+1、最小单位、现金充足、集中度等），不可绕过。
* **Observation（观测）**：压缩后的数据视图：行情/盘口摘要、技术特征、账户资产/仓位、风控姿态、主表信息、新闻要点。
* **BrokerAdapter**：券商接口抽象，含 **SandboxBroker** 与 **RealBroker**。
* **Decision Ledger**：决策总账（审计核心表）。
* **Model Gateway**：OpenAI 兼容中转站，路由到本地 Ollama 或云端 OpenAI 兼容模型。
* **主表（Master Table）**：A股证券静态属性与基础指标的标准化表。

---

## 3) 功能清单（优先级/验收） <a id="features"></a>

> 说明：P0=必须先上线；P1=次要但重要；P2=增强。

| 代号     | 功能                 | 说明                                  | 优先级  | 验收标准                                 |         |    |                |
| ------ | ------------------ | ----------------------------------- | ---- | ------------------------------------ | ------- | -- | -------------- |
| MG-01  | OpenAI 兼容模型网关      | `/v1/chat/completions`转发、权重路由、熔断、计费 | P0   | 可路由至本地 Ollama 与≥1个云端端点；错误重试；延迟/成本记录  |         |    |                |
| MG-02  | 动态模型端点配置           | 热增删端点、模型名映射、温度/超时/重试                | P0   | `GET/PUT /api/config/models` 生效，无需重启 |         |    |                |
| MD-01  | 主表抓取 & 标准化         | 合规源，日级全量+小时增量，幂等入库                  | P0   | 核心字段完整率≥99%，重复导入不产生脏数据               |         |    |                |
| MD-02  | 行情接入（WS/轮询）        | 逐笔/分钟线（至少分钟级），缓存                    | P0   | 分钟级延迟≤2s；断线自动重连                      |         |    |                |
| OBS-01 | 观测生成器（Observation） | 将多源数据压缩为轻量结构化观测                     | P0   | 单次生成≤50ms（内存缓存命中）                    |         |    |                |
| ACT-01 | Actor 决策           | 输入观测，输出动作 JSON（强 Schema）            | P0   | 非法结构率<0.5%；P95 延迟≤1.5s（云）/≤800ms（本地） |         |    |                |
| CHK-01 | Checker 审单         | 结构/一致性检查，返回 pass/fail               | P0   | 误放行≈0；超时 fail-safe                   |         |    |                |
| RK-01  | 硬风控                | 价格笼子/涨跌停/T+1/单位/现金/集中度              | P0   | 非法单全部拒绝并记录原因                         |         |    |                |
| EX-01  | 下单执行               | place/modify/cancel；幂等与重试           | P0   | 下单成功率≥99%；幂等 Key 防重复                 |         |    |                |
| SB-01  | 沙箱撮合               | 模拟涨跌停/T+1/最小单位、部分成交                 | P0   | 与规则一致；可回放                            |         |    |                |
| BR-01  | 券商适配               | 至少一个实盘 API 适配                       | P1   | 中性错误码、超时重试、节流                        |         |    |                |
| AUD-01 | 决策总账与审计            | 观测→决策→审查→风控→委托→成交链路                 | P0   | 100% 可追溯（trace_id 贯通）                |         |    |                |
| CFG-01 | 提示词中心              | 模板版本管理、灰度、回滚                        | P0   | 线上编辑、发布日志、A/B 标记                     |         |    |                |
| UI-01  | 仪表盘-总览             | 净值、回撤、胜率、活跃度、费用                     | P0   | 秒级更新（WS），查询窗口可选                      |         |    |                |
| UI-02  | 决策时间线              | 展示 Actor→Checker→风控→委托→成交           | P0   | 点击可展开原始 JSON 与审计细节                   |         |    |                |
| UI-03  | 模型观测               | tokens/延迟/失败率/成本                    | P1   | TOP 模型排行、趋势图                         |         |    |                |
| ADM-01 | 统一启动端点             | `/api/admin/start                   | stop | status                               | health` | P0 | 可部分组件启动；健康探针齐全 |
| DEP-01 | Docker 一键部署        | `docker-compose up -d`              | P0   | 首次部署<10分钟可起全栈                        |         |    |                |

---

## 4) 总体架构与流程 <a id="architecture"></a>

### 4.1 组件视图（文本示意）

```
[Frontend (Next.js)]
   │ WebSocket/REST
[API Gateway (FastAPI)]
   ├─ Admin/Config/Health
   ├─ Metrics/Streams
   ├─ Trader Orchestrator
   │    ├─ Observation Builder
   │    ├─ Actor (via Model Gateway)
   │    ├─ Checker (via Model Gateway / RuleChecker)
   │    ├─ Risk Gate
   │    └─ Execution Service → BrokerAdapter (Sandbox/Real)
   ├─ Strategy/Audit Service (记录用)
   └─ Data Ingestor (Master/Quotes/News 可选)
[Model Gateway (OpenAI-compatible) → Ollama/Cloud]
[PostgreSQL (+Timescale/pgvector)]  [Redis]  [Object Storage/MinIO]
```

### 4.2 关键时序（决策执行）

1. Ingestor 更新主表/行情 →
2. Observation Builder 生成 `observations`（带快照 id）→
3. Actor 调用：产出 `actions[]` JSON →
4. Checker 校验：`pass/fail + reasons` →
5. Risk Gate 硬风控（不可绕过）→
6. Execution 下单/撤改单 →
7. 回报入库，推送仪表盘 →
8. 全链路写入 Decision Ledger。

---

## 5) 详细设计（模块分解） <a id="design"></a>

### 5.1 Model Gateway（OpenAI 兼容）

**职责**：统一 `/v1/chat/completions`/`/v1/embeddings`；路由到本地 `ollama:11434` 或云端端点。
**关键点**：

* 路由策略：依据模型名、SLA、成本预算、失败率、延迟 P95 加权。
* 熔断：连续错误或延迟超阈，临时摘除。
* 观测：记录 `provider/model/tokens/latency/cost/trace_id`。
* 安全：提示词与输入脱敏（账号、密钥、PII）。
  **接口**：完全对齐 OpenAI；支持 `response_format`；支持 Tools/Function Calling（用于 JSON 固化）。

### 5.2 Data Ingestor（主表 & 行情）

**输入**：合规数据源（接口/文件/消息队列）。
**主表字段**（最小集）：`symbol, exchange, board, is_st, name, list_date, industry, market_cap, float_cap, pe_ttm, pb, tick_size, lot_size, trading_status, as_of_date, version`。
**策略**：

* 主表：日级全量 + 小时增量；版本化 `(symbol, as_of_date, version)`。
* 行情：分钟级（必需）/逐笔（可选）；断线重连、时间对齐。
  **幂等**：以 `upsert` 和 `checksum` 防重复。
  **错误**：数据缺失→降级为最近快照；超时→告警。

### 5.3 Observation Builder

**职责**：将主表、行情、账户、仓位、风险姿态汇总为**轻量观测 JSON**。
**性能**：内存缓存热键；单次构建≤50ms。
**输出**（示例见 §8.3）。
**校验**：观测有效期（如 3s）；过期则拒绝执行。

### 5.4 Actor（LLM 执行体）

**职责**：从观测生成**动作 JSON**（下单/撤单/改单/no_op），附 `rationale` & `confidence`。
**强化**：

* 多样本一致性（可选 `n>1` 投票）。
* 温度/长度限制与成本护栏。
  **失败处理**：输出非法或超时→`no_op` 并记录。

### 5.5 Checker（LLM/规则审单官）

**职责**：只检结构与一致性：

* 字段与取值域（价>0、`qty % lot_size==0` 等）；
* 仓位/现金/目标一致性（不会超限）；
* 时间性（观测超期则 fail）；
* 冲突动作（同批次互斥）。
  **超时策略**：Fail‑safe（不执行）。
  **替代**：关键时段切换为**RuleChecker**（更低延迟）。

### 5.6 Risk Gate（硬风控）

**硬规则**（不可关闭）：

* **交易所规则**：T+1、涨跌停、价格笼子、最小变动价位、最小交易单位；
* **账户规则**：现金充足、最大持仓集中度、单笔/单日成交额上限、当日成交量占比上限、黑名单/停牌。
  **实现**：配置文件 `risk.json` + 规则引擎（Pydantic 校验）。
  **输出**：`pass|reject` + `reasons[]` + 自动校正建议（如“调价至可成交区间”仅记录，不自动改）。
  **落地现状**：`DecisionService` 在 orchestrator→manager→managed_cycle 链路中写入 `RiskResult` 与 `DecisionLedger`，`RiskDecision` 结果与告警同步记录，实现 Actor → Checker → Risk → Execution 的可追溯闭环。

### 5.7 Execution Service & BrokerAdapter

**接口**：

* `place_order(symbol, side, qty, price, order_type, tif, client_order_id)`
* `modify_order(order_id, price?, qty?)` / `cancel(order_id)`
* `get_positions()` / `get_cash_balance()` / `get_order_status()`
  **特性**：
* 幂等：`client_order_id`（雪花/UUID）+ 去重表；
* 重试：网络/瞬时错误指数退避；
* 限流：券商 API 节流；
* 错误：映射为**中性错误码**（`BROKER_TIMEOUT`, `REJECT_PRICE_LIMIT` 等）。

### 5.8 SandboxBroker（沙箱撮合）

**撮合规则**：

* A股 T+1、涨跌停、最小单位、滑点/部分成交、撤单延迟。
* 模拟盘口：用分钟线+VWAP 估计成交；市价按 `ask1/bid1` 成交，限价检查价格带。
  **验证**：Replay 回放，结果一致性≥95%（统计口径可配置）。

### 5.9 审计与存证（Decision Ledger）

**记录**：

* `observations`、Actor 输出、Checker 输出、Risk 结果、订单与成交、费用、延迟、成本。
* 统一 `trace_id` 贯穿。
  **落地**：PostgreSQL（结构化），Object Storage（原始 JSON）。

### 5.10 配置中心

* **模型端点**：增删改查、熔断状态、权重、温度/超时、成本上限。
* **提示词模板**：多版本、灰度（按比例/按会话 key）、回滚。
* **风控参数**：集中度、黑名单、单笔限制、成交量占比等。
* **权限**：RBAC（管理员/交易员/观测）。

### 5.11 统一启动与调度

* `POST /api/admin/start`：按 `EXECUTION_MODE` 启动：`shadow|copilot|autopilot_strict`。
* `POST /api/admin/stop`：安全停机（先停 Actor 调用 → 清空挂单或只平不开模式）。
* `GET /api/admin/health`：依赖可用性/滞后/错误率。
* 调度：交易时段高频（1–5s），非交易时段降频；支持事件触发（超阈、告警）。

---

## 6) 数据模型（DDL 摘要） <a id="data"></a>



索引建议：

* `bar_1m(symbol, ts)` 主键已覆盖；
* `orders(status)`、`orders(symbol)`；
* `fills(order_id)`；
* `decision_ledger(created_at)`；
* `llm_invocations(created_at, role)`。

---

## 7) API 设计 <a id="api"></a>

### 7.1 统一启动/健康

* `POST /api/admin/start` → `{ components?: ["ingestor","trader","frontend"], mode: "shadow|copilot|autopilot_strict" }`
* `POST /api/admin/stop` → 可选组件停机
* `GET /api/admin/health` → 返回依赖状态（DB/Redis/ModelGateway/Quotes）
* `GET /api/admin/status` → 当前模式、延迟、错误率、最近决策数

### 7.2 交易编排（同步调用链）

* `POST /api/trader/decide`



* `POST /api/trader/feedback` → 成交/资金变化回传

### 7.3 配置中心

* `GET/PUT /api/config/models`：增删端点、模型权重、温度、超时、熔断；
* `GET/PUT /api/config/prompts`：模板 CRUD、发布与回滚；
* `GET/PUT /api/config/risk`：风控参数（JSON）与黑名单。

### 7.4 数据与审计

* `GET /api/metrics/equity_curve?from=&to=`
* `GET /api/metrics/trade_stats?window=30d`
* `GET /api/audit/decision/:id` → 返回全链路 JSON
* `GET /api/trade/orders?status=&symbol=` / `GET /api/trade/positions`

### 7.5 WebSocket

* `/api/stream`：订单、成交、PnL、告警、决策节点事件（actor/checker/risk/execution）

### 7.6 模型网关（OpenAI 兼容）

* `POST /v1/chat/completions`、`/v1/embeddings`；支持 `response_format={"type":"json_object"}`。

---

## 8) LLM 提示词与 JSON Schema <a id="prompts"></a>

### 8.1 Actor（系统提示模板，节选，可直接投放网关）

```
你是A股自动交易员。仅输出一个JSON对象（UTF-8，无多余文本）。
必须使用以下动作: ["place_order","modify_order","cancel_order","no_op"]。
字段：decision_id,timestamp,account_view,observations_ref,actions[],global_intent,notes。
要求：
- price>0，qty为最小交易单位整数倍，tif∈["day","ioc","fok"]。
- 每个action.intent给出rationale(<=240字)与confidence∈[0,1]。
- 不确定时选择no_op并说明原因。
- 预算与延迟控制：尽量在300个tokens内完成。
```

### 8.2 Checker（系统提示模板，节选）

```
你是审单官。输入为Actor动作JSON和当前观测摘要。
只检查：结构/取值域/状态一致性/时间性/冲突。输出：
{ "pass": true|false, "reasons": ["..."] }
不得提出新的交易观点或建议。
```

### 8.3 观测 Schema（示例）


### 8.4 动作 JSON Schema（约束落地）

### 8.5 Checker 输出 Schema


> 实现层建议用 **Pydantic** 强校验，超出范围直接驳回。

---

## 9) 前端仪表盘设计 <a id="frontend"></a>

### 9.1 页面结构

* **总览**：净值曲线、回撤、当日PnL、胜率、交易活跃度、费用、风险姿态拨盘。
* **决策时间线**：按时间展示 Actor→Checker→Risk→订单→成交链路；可展开每个 JSON。
* **仓位与暴露**：持仓Top、行业/板块暴露、集中度、现金占比。
* **策略/审计**：策略记录卡片、审计明细检索。
* **模型观测**：调用量、延迟、失败率、tokens、成本。
* **配置中心**：模型端点、提示词模板、风控参数在线配置（RBAC 控制）。

### 9.2 前端数据契约

* WS `/api/stream` 推送事件：`actor_decision`, `checker_result`, `risk_result`, `order_update`, `fill`, `pnl_update`, `alert`。
* REST：同 §7；净值曲线返回 `[{"ts": "...", "nav": 1_000_000}]`；胜率/活跃度提供时间窗聚合。

---

## 10) 部署与运维（Docker、统一启动、观测） <a id="devops"></a>

### 10.1 目录结构（建议）

```
repo/
  api/                  # FastAPI 服务
  trader/               # Orchestrator/Actor-Checker编排与Risk/Exec
  model-gateway/        # OpenAI兼容网关
  ingestor/             # 数据接入
  frontend/             # Next.js
  deploy/
    docker-compose.yml
    .env.example
  sql/
    init.sql            # DDL
  prompts/
    actor.json          # 模板与版本
    checker.json
  configs/
    models.yaml
    risk.json
```


### 10.4 观测与报警

* **Metrics**（Prometheus）：

  * `tradebot_decision_latency_ms{stage=actor|checker|risk|exec}`
  * `tradebot_orders_total{status}`、`tradebot_reject_total{reason}`
  * `llm_tokens_total{role}`、`llm_latency_ms{model}`、`llm_errors_total`
  * `market_data_lag_ms`、`equity_nav`、`pnl_intraday`
* **Logging**：结构化 JSON，包含 `trace_id/decision_id`。
* **Tracing**：OpenTelemetry（Actor→Checker→Risk→Broker 整条 span）。

---

## 11) 测试计划与验收 <a id="testing"></a>

### 11.1 用例类型

* **单元测试**：Schema 校验、风控边界、撮合逻辑、幂等/重试。
* **集成测试**：Actor→Checker→Risk→Exec→回报全链路（沙箱）。
* **回放测试**：以历史分钟线回放，验证拒单/成交一致性。
* **稳定性/容错**：数据源抖动、模型超时、券商限流、DB 重启。
* **性能**：P95 时延、并发 20 决策/秒下延迟与错误率。
* **安全**：权限与配置变更审计、密钥保护。

### 11.2 验收标准（关键）

* P95 观测→下单链路：本地模型≤800ms，云模型≤1.5s。
* 风控拒单前的非法动作率 < 0.5%，Checker 误放行≈0。
* 100% 决策有审计链路。
* Docker 一键启动成功，仪表盘可见净值曲线、决策时间线。

---

## 12) 安全、风控与合规 <a id="risk"></a>

* **合规边界**：交易所/券商规则必须实现于 Risk Gate；任何策略/模型输出不得越过。
* **Kill‑Switch**：紧急停止新开仓、仅平仓；`POST /api/admin/stop` 支持一键触发。
* **数据授权**：确保行情/主表/公告数据的合法授权与用途声明。
* **隐私与密钥**：使用 Docker Secrets/环境变量；访问日志脱敏；模型网关中对提示词敏感内容掩码。
* **影子/灰度**：先 `shadow` 跑 3 个交易日，再 `copilot`，最后 `autopilot_strict` 小额度上线。

---

## 13) 实施计划、WBS、RACI <a id="plan"></a>

### 13.1 角色分工（RACI）

* **架构/后端负责人（A/R）**：总体架构、Trader Orchestrator、Risk、Exec。
* **数据负责人（A/R）**：主表/行情 Ingestor、Observation。
* **前端负责人（A/R）**：仪表盘、WS 订阅、配置中心。
* **DevOps（A/R）**：Docker、CI/CD、监控与告警。
* **策略/审计（C）**：提示词模板、审计需求定义。
* **合规（C/I）**：规则检查、上线把关。

### 13.2 WBS（里程碑为两周一迭代示例）

**迭代1（P0骨架）**

* 建库（DDL）、Model Gateway 雏形（本地Ollama路由）、主表抓取最小实现、Observation Builder v1、Actor/Checker 模板、Risk Gate 最小规则、Sandbox 撮合 v1、统一启动端点、仪表盘净值曲线+实时订单流。

**迭代2（P0完善）**

* 订单幂等与重试、中性错误码、决策总账、决策时间线、风控完善（集中度/价格笼子）、模型端点动态管理、提示词中心 CRUD。

**迭代3（P1）**

* 券商适配器接入（实盘联调沙盒环境）、模型观测面板、A/B 提示词灰度、告警与SLO、影子运行全日。

**迭代4（P1→实盘小流量）**

* `copilot` 小额度，风险阈值保护；回归测试；文档/Runbook 完成；合规评审。

**迭代5（稳态）**

* `autopilot_strict` 小流量→逐步扩大；成本治理与延迟优化。

---

## 14) 上线与运行手册（Runbook） <a id="runbook"></a>

1. **首次部署**：

   * `docker-compose -f deploy/docker-compose.yml up -d`
   * 导入 `sql/init.sql`；配置 `.env`、`configs/models.yaml`、`configs/risk.json`、`prompts/*`。
2. **健康检查**：`GET /api/admin/health` should be OK；仪表盘无红灯。
3. **数据检查**：主表有 ≥ 4000+ 条（示例），分钟线连续。
4. **运行模式**：设为 `shadow` → 观察 3 日 → 切 `copilot`（高置信度自动执行，阈值 0.65）→ 小流量实盘。
5. **故障处置**：

   * 模型大量超时 → 切本地模型 & 降频；
   * 券商接口波动 → 启动节流与重试；
   * 风险事件 → Kill‑Switch（只平不开）。
6. **审计导出**：`GET /api/audit/decision/:id` 或按日导出 CSV/JSON。

---

# 附：工程落地“任务清单”（可发给团队）

### 后端（P0必须）

* [ ] 搭建 FastAPI 项目骨架（路由、依赖、错误中间件、OpenAPI 文档）。
* [ ] 实现 Model Gateway（OpenAI 兼容，路由到 Ollama + 云端一处）。
* [ ] DDL 执行（§6），接入 SQLAlchemy + Alembic。
* [ ] Ingestor：主表抓取（日级+小时增量）、分钟行情订阅与入库。
* [ ] Observation Builder：缓存与TTL、Schema。
* [ ] Actor 调用：`response_format=json`，Schema 校验（Pydantic）。
* [ ] Checker：LLM版 + RuleChecker 版（配置切换）。
* [ ] Risk Gate：价格笼子/涨跌停/T+1/单位/现金/集中度/黑名单。
* [ ] Execution：幂等、节流、重试；SandboxBroker v1。
* [ ] Decision Ledger：全链路写入；`trace_id` 贯通。
* [ ] Admin 启动/停止/健康；Metrics（Prometheus）。
* [ ] WebSocket 推送流与订阅。

### 前端（P0必须）

* [ ] 总览页（净值曲线、回撤、PnL、活跃度）。
* [ ] 决策时间线（展开JSON、查看拒单原因）。
* [ ] 订单/成交/持仓视图。
* [ ] 配置中心（模型端点、风控、提示词模板 CRUD）。
* [ ] 模型观测（P1）。

### DevOps（P0必须）

* [ ] Dockerfile/Compose & .env 模板；日志/指标/追踪接入。
* [ ] CI/CD（构建镜像、推仓库、自动化部署脚本）。
* [ ] 告警规则：数据滞后、决策延迟、拒单陡增、模型错误率、券商限流。
* [ ] 备份/恢复策略（DB & 对象存储）。

### 提示词与配置（P0必须）

* [ ] Actor/Checker 模板完善与版本化；
* [ ] 风控 `risk.json` 初始阈值；
* [ ] 模型端点列表与权重；
* [ ] 黑名单初始化（ST/停牌等）。

---

**一句话总结**：
本文档提供了从**功能清单→详细模块→数据模型→API→提示词与Schema→前端→部署→测试→运维**的全套落地规范。按此执行，团队可以先以 **沙箱闭环** 达到 P0 验收，再平滑切换到 **LLM 主导的实盘小流量**，在强审计与硬风控保护下逐步扩大规模。
