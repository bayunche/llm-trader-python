{
  "scan_timestamp": "2025-11-04T20:49:00.477853+08:00",
  "areas": [
    {
      "name": "证券主表采集与降级路径",
      "locations": [
        "src/llm_trader/data/pipelines/symbols.py",
        "src/llm_trader/data/repositories/parquet.py",
        "scripts/run_full_pipeline.py"
      ],
      "current_state": "SymbolsPipeline 依次尝试东方财富 push2 多个子域抓取全量证券主表，失败后回退至上交所/深交所接口。近期改造引入 HTTP header/多端点及缓存兜底，但 `_fetch_szse` 响应结构为 list 时触发 AttributeError，且 `fetch()` 在降级读取本地 `symbols.parquet` 时仍遗留调试 placeholder，未真正返回缓存，造成 DataSourceError。",
      "similar_cases": [
        "tests/data/test_symbols_pipeline.py",
        "tests/pipeline/test_full_pipeline.py"
      ],
      "tech_stack": [
        "Python 3.10",
        "httpx",
        "tenacity",
        "PyArrow Parquet"
      ],
      "tests": [
        "tests/data/test_symbols_pipeline.py"
      ],
      "notes": "需要增强深交所返回值解析和缓存兜底逻辑，确保全流程在外部接口波动时仍能继续。"
    },
    {
      "name": "候选标的自动筛选",
      "locations": [
        "src/llm_trader/trading/orchestrator.py",
        "src/llm_trader/pipeline/auto.py"
      ],
      "current_state": "TradingOrchestrator 自动从仓储读取最新证券主表并按成交额等指标筛选标的；若 `symbols.parquet` 缺失则依赖符合同步流程的成功执行。",
      "similar_cases": [
        "tests/trading/test_orchestrator.py"
      ],
      "tech_stack": [
        "Python 3.10",
        "pandas",
        "dataclasses"
      ],
      "tests": [
        "tests/trading/test_orchestrator.py"
      ],
      "notes": "符号列表回退路径需与 symbols pipeline 修复同步验证。"
    },
    {
      "name": "历史行情与实时展示",
      "locations": [
        "src/llm_trader/data/pipelines/ohlcv.py",
        "dashboard/app.py",
        "docs/realtime_data.md"
      ],
      "current_state": "行情管道支持历史与实时数据落地，Streamlit 仪表盘提供实时交易记录与图表；README 已描述免 Docker 启动流程。",
      "similar_cases": [
        "tests/data/test_ohlcv_pipeline.py",
        "tests/dashboard/test_data_access.py"
      ],
      "tech_stack": [
        "Streamlit",
        "Plotly",
        "PyArrow"
      ],
      "tests": [
        "tests/dashboard/test_data_access.py"
      ],
      "notes": "仪表盘依赖数据仓储更新；若 symbols 同步失败，将影响可视化完整性。"
    },
    {
      "name": "交易与 LLM 历史记录",
      "locations": [
        "src/llm_trader/trading/session.py",
        "src/llm_trader/data/repositories/parquet.py",
        "src/llm_trader/strategy/logger.py",
        "src/llm_trader/pipeline/auto.py",
        "dashboard/data.py",
        "dashboard/app.py",
        "src/llm_trader/api/utils.py"
      ],
      "current_state": "TradingSession 将订单/成交/权益写入 Parquet，但当订单列表为空时不会生成记录；LLMStrategyLogRepository 将 prompt/response 落到 JSONL，仪表盘的“LLM 策略日志”可显示最近记录。然而缺少统一的交易循环历史表，用于关联模型输入输出与当次交易结果。",
      "similar_cases": [
        "tests/data/test_trading_repository.py",
        "tests/api/test_trading.py",
        "tests/dashboard/test_data_access.py"
      ],
      "tech_stack": [
        "PyArrow Parquet",
        "JSON Lines",
        "FastAPI",
        "Streamlit"
      ],
      "tests": [
        "tests/api/test_trading.py",
        "tests/dashboard/test_data_access.py",
        "tests/tasks/test_managed_cycle.py"
      ],
      "notes": "需要在订单缺失时仍保存执行摘要，并通过 API/仪表盘统一暴露模型调用记录、策略输出与交易结果。"
    }
  ],
  "observation_report": {
    "anomalies": [
      "深交所接口返回 JSON list 时未被解析函数兼容，引发 AttributeError（已在近期修复）。"
    ],
    "information_gaps": [
      "外部依赖 AkShare 等第三方采集方案尚未评估，可作为后续扩展。",
      "交易历史摘要仍未落盘，需要确定写入位置与数据结构。"
    ],
    "suggested_deep_dives": [
      "梳理 run_full_automation 与 run_managed_trading_cycle 的执行顺序，确定何处记录运行摘要最合适。",
      "检查 dashboard/data.py 的缓存逻辑，规划如何新增历史接口而不破坏现有分页。"
    ],
    "tool_notes": {
      "code_index": "项目未配置 code-index MCP，已改用 shell/rg 检索并将在 operations-log.md 记录。",
      "sequential_thinking": "任务开始已调用 MCP sequential-thinking 工具记录思路。"
    }
  }
}
