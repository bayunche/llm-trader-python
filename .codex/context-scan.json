{
  "scan_timestamp": "2025-11-03T15:25:45+08:00",
  "areas": [
    {
      "name": "交易执行模式配置",
      "locations": [
        "src/llm_trader/config/settings.py",
        "src/llm_trader/trading/execution_adapters.py",
        "src/llm_trader/trading/orchestrator.py",
        ".env.example",
        "docker-compose.prod.yml"
      ],
      "current_state": "TradingSettings.execution_mode 通过环境变量 TRADING_EXECUTION_MODE 读取，默认 sandbox；orchestrator 创建 TradingSession 时依据 config.execution_mode 选择沙盒或实盘适配器；实盘适配器目前未实现，直接抛出 NotImplementedError。",
      "similar_cases": [
        "tests/trading/test_session.py",
        "tests/trading/test_orchestrator.py"
      ],
      "tech_stack": [
        "Python 3.10",
        "dataclasses",
        "自研撮合引擎"
      ],
      "tests": [
        "tests/trading/test_session.py",
        "tests/trading/test_orchestrator.py",
        "tests/pipeline/test_auto.py"
      ],
      "notes": "当前代码已支持通过环境变量切换执行模式，但缺乏针对 live 模式的安全开关提示，并且文档需明确说明 live 需要额外适配器支持。"
    },
    {
      "name": "全流程自动化脚本",
      "locations": [
        "scripts/run_full_pipeline.py",
        "src/llm_trader/pipeline/auto.py",
        "src/llm_trader/trading/orchestrator.py",
        "src/llm_trader/backtest"
      ],
      "current_state": "run_full_pipeline.py 同步标的与行情后构建 AutoTradingConfig，串联 run_full_automation（策略→回测→风控→报表）；当前逻辑在 run_backtest 为真时若缺少数据或达不到指标会提前退出。",
      "similar_cases": [
        "tests/pipeline/test_auto.py"
      ],
      "tech_stack": [
        "pandas",
        "自研 BacktestRunner",
        "llm_trader.trading orchestrator"
      ],
      "tests": [
        "tests/pipeline/test_auto.py",
        "tests/backtest/test_engine.py",
        "tests/tasks/test_managed_cycle.py"
      ],
      "notes": "需确认当 run_backtest=false 时依然保证交易执行与报表流程完整，避免 live 模式受回测回退路径影响。"
    },
    {
      "name": "Docker 启动与集成",
      "locations": [
        "Dockerfile",
        "docker/entrypoint.sh",
        "docker-compose.prod.yml",
        "start.sh",
        "dashboard/app.py"
      ],
      "current_state": "生产镜像 ENTRYPOINT 执行 run_full_pipeline.py 后启动 Streamlit 仪表盘；docker-compose 暴露 DASHBOARD_PORT 并挂载工程目录，单服务容器同时承担数据同步、策略执行和仪表盘职责。",
      "similar_cases": [
        "docs/realtime_data.md",
        "README.md"
      ],
      "tech_stack": [
        "Docker",
        "Streamlit",
        "bash"
      ],
      "tests": [
        "无专门自动化测试，依赖手动或冒烟脚本"
      ],
      "notes": "当前入口一旦 run_full_pipeline 失败会导致 dashboard 无法启动；需评估重构结构以分阶段执行并暴露状态。"
    },
    {
      "name": "报表与仪表盘",
      "locations": [
        "src/llm_trader/reports",
        "dashboard/app.py",
        "tests/dashboard/test_data.py",
        "README.md"
      ],
      "current_state": "ReportBuilder/ReportWriter 在 pipeline.auto 中被调用写入报告；dashboard 读取 reports 目录展示交易结果和 LLM 日志；需确保重构后输出路径与仪表盘数据源保持一致。",
      "similar_cases": [
        "tests/dashboard/test_data.py"
      ],
      "tech_stack": [
        "pandas",
        "streamlit",
        "altair"
      ],
      "tests": [
        "tests/dashboard/test_data.py"
      ],
      "notes": "报表目录由 REPORT_OUTPUT_DIR 控制，默认 reports；仪表盘预期同目录可访问。"
    },
    {
      "name": "配置与文档",
      "locations": [
        ".env.example",
        "README.md",
        "docs/",
        "verification.md"
      ],
      "current_state": "文档描述需要在 .env 中配置 API key 及执行模式，但未强调 live 模式需要额外券商适配器；验证文档未覆盖 live/sandbox 切换测试步骤。",
      "similar_cases": [
        "docs/strategy_llm.md",
        "docs/realtime_data.md"
      ],
      "tech_stack": [
        "Markdown",
        "Poetry/pytest 工作流"
      ],
      "tests": [
        "verification.md（手工步骤）"
      ],
      "notes": "需要统一更新所有文档描述，避免用户误以为 live 模式已可用。"
    }
  ],
  "observation_report": {
    "anomalies": [
      "LiveBrokerExecutionAdapter 仍为占位实现，需要在文档中明确，并在执行入口处添加保护提示。",
      "未找到 code-index MCP 工具，当前依靠 shell/rg 进行检索，已记录原因。"
    ],
    "information_gaps": [
      "尚未确认 docker 容器内运行失败时如何重试整个流程，需要在重构阶段规划。",
      "需要了解 dashboard 当前依赖的报表结构，以便重构后保持兼容。"
    ],
    "suggested_deep_dives": [
      "跟进 run_full_pipeline 失败时的异常处理逻辑，评估是否需要拆分为可重启子流程。",
      "梳理 tests/pipeline/test_auto.py 与实际运行流程的覆盖差距，为后续测试补强提供依据。"
    ],
    "tool_notes": {
      "code_index": "未提供对应 MCP 工具，已在日志和上下文记录改用 shell/rg 的替代方案。"
    }
  }
}
