---
title: LLM-First 重构计划
updated_at: 2025-11-07T14:04:10+08:00
maintainer: Codex
---

# LLM-First A 股交易机器人重构计划

> 文档目标：记录基于《项目需求.md》的重构任务、状态与交付物，并在每个子任务完成后更新。

## 总体目标

1. 以 PostgreSQL + Redis 为核心重建数据与缓存层，支撑观测、决策、风控、执行、审计与配置中心。
2. 构建 Actor → Checker → Risk Gate → 执行 → 审计的完整决策链，并通过模型网关实现多端点路由与调用审计。
3. 交付包含 Next.js 仪表盘、REST/WS API、模型网关、调度服务的 Docker Compose 编排与统一启动入口，满足 ADM-01、DEP-01。
4. 完成自动化测试体系与 Runbook、灰度策略、监控告警配置，确保上线与运维可复制。

## 任务进度

| 序号 | 任务名称 | 描述 | 当前状态 | 负责人 | 备注 |
| --- | --- | --- | --- | --- | --- |
| 1 | 设计 PostgreSQL 数据模型与迁移框架 | 建立 SQLModel ORM、Alembic 迁移、初始 Schema。 | ✅ 已完成 | Codex | 迁移脚本 `alembic/versions/0001_initial_schema.py`，初始化脚本 `scripts/init_db.py`。 |
| 2 | 实现数据采集与观测生成服务 | 主表/行情/账户入库，结合 Redis 缓存构建 OBS‑01 观测生成器。 | ✅ 已完成 | Codex | 完成 PostgreSQL 仓储、观测构建、账户快照采集与统一调度导出（自动生成 scheduler 配置与账户任务）。 |
| 3 | 构建模型网关与 Actor/Checker 服务 | 落地 MG‑01/02、ACT‑01、CHK‑01，统一模型路由、提示词与调用审计。 | 🚧 进行中 | Codex | 模型网关熔断/指标接口就绪，Actor/Checker 服务接入 orchestrator；config_models 惰性化并以分组 pytest 验证，调度任务可动态加载数据库端点。 |
| 4 | 实现 Risk Gate、沙箱撮合与执行控制层 | 实现 RK‑01、SB‑01、EX‑01，含幂等、重试、订单状态机与券商适配。 | 🚧 进行中 | Codex | Risk Gate 已与 DecisionService 打通，后续完善风险配置、执行持久化与实盘适配。 |
| 5 | 搭建决策总账与审计留痕体系 | 构建 Decision Ledger、订单/成交存证，支持按日/按决策导出。 | 🚧 进行中 | Codex | DecisionLedger/RiskResult 已写入，下一步补充审计 API 与仪表盘集成。 |
| 6 | 构建配置中心与运行模式管理 | 实现 CFG‑01 与 ADM‑01，覆盖模型端点、提示词、风控参数及 SystemState。 | ⏳ 未开始 | Codex | 依赖任务 1、3、4。 |
| 7 | 实现 API 网关与 Next.js 仪表盘 | 提供 REST/WS 接口与 Next.js 仪表盘，展示指标、决策时间线、模型日志。 | ⏳ 未开始 | Codex | 依赖任务 5、6。 |
| 8 | 统一启动、容器化与监控交付 | 编排 Compose（API、Worker、模型网关、Next.js、PostgreSQL、Redis），实现健康探针与监控。 | ⏳ 未开始 | Codex | 依赖任务 2、3、4、6、7。 |
| 9 | 测试体系、Runbook 与文档交付 | 完成自动化测试、部署手册、Runbook、灰度策略、验证记录更新。 | ⏳ 未开始 | Codex | 依赖任务 8、7。 |

## 更新记录

- 2025-11-05T14:01:09+08:00：创建计划文档并标记任务 1 完成。
- 2025-11-05T14:20:21+08:00：同步详细方案，更新目标、任务描述与依赖。
- 2025-11-05T14:34:39+08:00：完成 PostgreSQL 数据仓储、采集服务与观测构建器，实现任务 2 的核心能力。
- 2025-11-05T14:51:06+08:00：将采集与观测流程接入统一入口脚本，补充数据库/Redis 配置示例。
- 2025-11-05T14:56:10+08:00：调度任务 run_cycle 引入 PostgreSQL/Redis 数据采集与观测构建。
- 2025-11-05T15:18:28+08:00：完成观测缓存命中策略与指标记录。
- 2025-11-05T21:36:40+08:00：新增账户快照管道及调度任务，支持自动导出 scheduler 配置并在缺失时由入口脚本生成。  
- 2025-11-06T09:57:37+08:00：完成模型网关熔断指标 API、配置中心路由与 Actor/Checker 服务序列化修复，任务 3 进入进行中状态。
- 2025-11-06T13:56:12+08:00：orchestrator 接入 Actor/Checker 调用链并将 Decision/CheckerResult 入库，调度任务注入模型网关与决策服务。
- 2025-11-07T10:12:00+08:00：修复证券主表管道交易所降级策略、补充离线依赖与分段 pytest 文档，推进测试稳定性建设。
- 2025-11-07T14:38:00+08:00：新增 model_gateway.loader，API 与调度统一加载数据库端点，完成 loader/unit tests 与 Managed Cycle 分组验证。
- 2025-11-07T14:45:00+08:00：ModelGateway 服务默认改用 loader 读取 DB 配置，CLI/脚本入口无需重启即可感知配置中心变更。
- 2025-11-07T14:04:10+08:00：config_models 模块改为惰性实例化 ModelGateway，修复本地无数据库场景 600s 超时，并以分组 pytest 记录验证结果。
- 2025-11-07T14:52:00+08:00：发布 `/api/monitor/llm-calls` 模型审计接口，外部监控可直接查询 Actor/Checker 调用日志。
- 2025-11-07T15:07:00+08:00：扩展 managed_cycle 与 trading.manager 风险测试，确认模型端点变更后 Actor/Checker/Risk/执行链仍保持闭环并写入 RiskResult/DecisionLedger。
- 2025-11-07T15:18:00+08:00：新增 `/api/trading/decisions` 决策审计接口，导出 DecisionLedger+RiskResult 数据，完成 Task 5 审计 API。
- 2025-11-07T15:36:00+08:00：实现 `/api/trading/decisions/{decision_id}` 详情及执行闭环新测试（RiskPolicy OK→EXECUTED），审计链路与执行验证基本收尾。

## 更新规范

1. 每完成一项任务，更新表格状态、备注，并追加更新记录（UTC+8 时间）。
2. 如任务范围或依赖调整，及时修改描述并在更新记录注明原因。
